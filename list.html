<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vehicle CSV â€” Search + Voice</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --text:#e5e7eb; --muted:#a7b0c8;
    --outline:#1f2a44;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:780px;margin:0 auto;padding:14px 14px 80px}
  header{display:flex;gap:8px;align-items:center;margin:8px 0 14px}
  header img{width:36px;height:36px;border-radius:8px;border:1px solid var(--outline)}
  h1{font-size:clamp(18px,3.8vw,26px);margin:0}
  .subtitle{color:var(--muted);font-size:12px}
  .card{background:linear-gradient(180deg,#0b1220,#0a0f1c);border:1px solid var(--outline);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .input{flex:1;display:flex;align-items:center;background:#0a1428;border:1px solid #2b3a5f;border-radius:12px;padding:10px 12px}
  .input input{flex:1;border:0;background:transparent;outline:none;color:#e5e7eb;font-size:16px}
  .btn{border:0;border-radius:12px;padding:10px 12px;background:#1f2937;color:#e5e7eb;border:1px solid #334155;cursor:pointer;font-weight:600}
  .btn.mic{background:#6d28d9;border-color:#6d28d9}
  .btn.mic.listening{background:#ef4444;border-color:#ef4444}
  .list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .item{background:linear-gradient(180deg,#0b1220,#0a0f1b);border:1px solid #1f2a44;border-radius:12px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
  .plate{letter-spacing:0.06em;font-weight:800;color:#93c5fd}
  .badge{padding:6px 10px;border-radius:999px;background:#052e12;border:1px solid #14532d;color:#bbf7d0;font-weight:700;font-size:12px}
  .hint{color:#a7b0c8;font-size:12px;margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="car_logo.jpg" alt="logo" onerror="this.style.display='none'">
      <div>
        <h1>Vehicle CSV</h1>
        <div class="subtitle">Import a CSV and use your existing search + voice</div>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <label class="btn">
          <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none">
          Import CSV
        </label>
        <button class="btn" id="exportBtn">Export CSV</button>
        <span id="count" class="subtitle">0 rows</span>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="input"><input id="searchBox" placeholder="Search Vehicle..." inputmode="latin" autocapitalize="characters" autocomplete="off"></div>
        <button class="btn mic" id="micBtn" title="Voice search">ðŸŽ¤ Voice</button>
        <button class="btn" id="clearBtn">Clear</button>
      </div>
      <div id="voiceHint" class="hint"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div id="list" class="list"></div>
      <div id="empty" class="hint">No rows yet. Import a CSV to begin.</div>
      <div class="hint">CSV headers accepted: <b>vehicleNumber</b> OR <b>Code, Number, Suffix</b> (auto-joined as CODE####X).</div>
    </div>
  </div>

<script>
  // --- Expect these in your repo from the main app ---
  // window.initializeVoiceRecognition()
  // window.startVoiceSearch(inputElement, buttonElement)
  const hasVoice = typeof window.initializeVoiceRecognition === 'function'
                && typeof window.startVoiceSearch === 'function';

  // Minimal no-API fallback
  function showHint(msg){ document.getElementById('voiceHint').textContent = msg || ''; }

  if(hasVoice){
    try{ window.initializeVoiceRecognition(); }catch(e){}
    showHint('Voice ready â€” tap ðŸŽ¤ and speak the plate.');
  }else{
    showHint('Voice module not found. This page will still work; add your voice script to enable the mic.');
  }

  // --- CSV + List + Filtering ---
  let allRows = [];   // {vehicleNumber}
  let filtered = [];
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const countEl = document.getElementById('count');
  const searchBox = document.getElementById('searchBox');
  const micBtn = document.getElementById('micBtn');

  function normalizePlate(s){
    return (s||'').toString().toUpperCase().replace(/\s+/g,'').replace(/O/g,'0').replace(/[^A-Z0-9]/g,'');
  }
  function joinFromColumns(row){
    let plate = row.vehicleNumber || row.VehicleNumber || row.plate || row.Plate;
    if(plate) return normalizePlate(plate);
    const code = row.Code || row.code;
    const num = row.Number || row.number;
    const suffix = row.Suffix || row.suffix;
    if(code && num && suffix) return normalizePlate(`${code}${num}${suffix}`);
    return '';
  }

  function render(){
    listEl.innerHTML = '';
    if(filtered.length === 0){
      emptyEl.style.display = 'block'; countEl.textContent = '0 rows'; return;
    }
    emptyEl.style.display = 'none';
    countEl.textContent = filtered.length + ' rows';
    const frag = document.createDocumentFragment();
    filtered.forEach(r => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div class="plate">${r.vehicleNumber}</div><span class="badge">Cleared</span>`;
      frag.appendChild(div);
    });
    listEl.appendChild(frag);
  }
  function applyFilter(){
    const term = normalizePlate(searchBox.value);
    filtered = term ? allRows.filter(r => r.vehicleNumber.includes(term)) : [...allRows];
    render();
  }

  // Import
  document.getElementById('csvFile').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(!lines.length){ alert('Empty CSV'); return; }
    const headers = lines[0].split(',').map(h => h.trim());
    allRows = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(',').map(c => c.trim());
      const row = Object.fromEntries(headers.map((h,idx)=>[h, cols[idx] || '']));
      const plate = joinFromColumns(row);
      if(plate) allRows.push({vehicleNumber: plate});
    }
    filtered = [...allRows];
    applyFilter();
  });

  // Export
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    if(!allRows.length){ alert('Nothing to export.'); return; }
    const csv = 'vehicleNumber,status\\n' + allRows.map(r => `${r.vehicleNumber},Cleared`).join('\\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'vehicle_clearances.csv';
    a.click();
  });

  // Search
  searchBox.addEventListener('input', ()=>{ if(window.__t) clearTimeout(window.__t); window.__t = setTimeout(applyFilter, 120); });
  document.getElementById('clearBtn').addEventListener('click', ()=>{ searchBox.value=''; applyFilter(); });

  // Voice (delegate to your existing module)
  micBtn.addEventListener('click', ()=>{
    if(hasVoice){ window.startVoiceSearch(searchBox, micBtn); }
    else { searchBox.focus(); alert('Add your voice module script to enable the mic.'); }
  });
</script>
</body>
</html>
