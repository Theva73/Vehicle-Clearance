<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vehicle Listings - Apple Watch Enhanced</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #000000;
    --panel: #1a1a1a;
    --text: #ffffff;
    --muted: #8e8e93;
    --outline: #2c2c2e;
    --accent: #30d158;
    --accent-dark: #28cd41;
    --red: #ff453a;
    --red-dark: #d70015;
    --yellow: #ffd60a;
    --purple: #bf5af2;
    --purple-dark: #9d4edd;
    --blue: #007aff;
    --blue-dark: #0056cc;
  }

- { box-sizing: border-box; }

html, body {
height: 100%;
margin: 0;
overflow: hidden;
}

/* Apple Watch Ultra optimizations */
@media screen and (max-width: 500px) {
html, body {
overflow: auto;
height: auto;
}
}

body {
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
color: var(–text);
font-family: ‘Inter’, system-ui, sans-serif;
}

.wrap {
max-width: 780px;
margin: 0 auto;
display: flex;
flex-direction: column;
height: 100vh;
position: relative;
}

@media screen and (max-width: 500px) {
.wrap {
height: auto;
min-height: 100vh;
}
}

.sticky-header {
position: fixed;
top: 0;
left: 0;
right: 0;
z-index: 100;
max-width: 780px;
margin: 0 auto;
padding: 16px 14px;
background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
border-bottom: 1px solid rgba(255, 255, 255, 0.05);
backdrop-filter: blur(20px);
}

.scroll-content {
flex-grow: 1;
overflow-y: auto;
padding: 320px 14px 80px 14px;
display: flex;
flex-direction: column;
}

@media screen and (max-width: 500px) {
.scroll-content {
overflow-y: visible;
}
}

.scroll-content.is-centered {
justify-content: center;
align-items: center;
min-height: calc(100vh - 320px);
}

/* Enhanced Weather Panel */
.weather-panel {
background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
border: 2px solid rgba(59, 130, 246, 0.5);
border-radius: 20px;
padding: 16px;
margin-bottom: 16px;
position: relative;
overflow: hidden;
box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2),
0 0 0 1px rgba(255, 255, 255, 0.05);
backdrop-filter: blur(20px);
}

.weather-panel::before {
content: ‘’;
position: absolute;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
animation: weatherGlow 6s ease-in-out infinite alternate;
}

.weather-content {
position: relative;
z-index: 2;
display: flex;
justify-content: space-between;
align-items: center;
}

.weather-main {
display: flex;
align-items: center;
gap: 12px;
}

.weather-icon {
font-size: 2.5rem;
filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
animation: iconFloat 3s ease-in-out infinite;
}

.weather-temp {
font-size: 3rem;
font-weight: 800;
color: white;
text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.weather-status {
color: rgba(255,255,255,0.9);
font-weight: 600;
font-size: 1.1rem;
}

.weather-forecast {
display: flex;
flex-direction: column;
gap: 8px;
text-align: right;
}

.forecast-item {
display: flex;
align-items: center;
gap: 8px;
justify-content: flex-end;
color: rgba(255,255,255,0.8);
font-size: 0.9rem;
}

.forecast-temp {
font-weight: 600;
min-width: 35px;
}

.forecast-dot {
width: 12px;
height: 12px;
border-radius: 50%;
background: linear-gradient(45deg, #f59e0b, #ef4444);
box-shadow: 0 2px 4px rgba(0,0,0,0.3);
animation: dotPulse 2s ease-in-out infinite;
}

.forecast-dot.green { background: linear-gradient(45deg, #22c55e, #16a34a); }
.forecast-dot.yellow { background: linear-gradient(45deg, #f59e0b, #d97706); }
.forecast-dot.red { background: linear-gradient(45deg, #ef4444, #dc2626); }

.forecast-time {
font-size: 0.8rem;
opacity: 0.7;
}

/* Header */
header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.header-left {
flex-grow: 1;
}

h1 {
font-size: clamp(20px, 4vw, 28px);
margin: 0;
font-weight: 800;
}

.subtitle {
color: var(–muted);
font-size: 14px;
margin-top: 4px;
}

/* Enhanced Search Panel */
.search-panel {
background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2e 50%, #3a3a3c 100%);
border: 2px solid rgba(191, 90, 242, 0.3);
border-radius: 20px;
padding: 20px;
position: relative;
overflow: hidden;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5),
0 0 0 1px rgba(255, 255, 255, 0.05);
backdrop-filter: blur(20px);
}

.search-panel::before {
content: ‘’;
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
animation: searchSweep 4s infinite;
}

.search-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 16px;
position: relative;
z-index: 2;
}

.search-title {
font-size: 1.2rem;
font-weight: 700;
color: var(–text);
display: flex;
align-items: center;
gap: 8px;
}

.search-time {
color: var(–muted);
font-size: 0.9rem;
font-weight: 500;
}

.vehicle-count-badge {
background: linear-gradient(135deg, var(–purple), var(–purple-dark));
color: white;
padding: 4px 12px;
border-radius: 12px;
font-size: 0.8rem;
font-weight: 600;
box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
}

/* Buttons and Inputs */
.row {
display: flex;
gap: 12px;
flex-wrap: wrap;
align-items: center;
position: relative;
z-index: 2;
}

.input {
flex: 1;
display: flex;
align-items: center;
background: rgba(28, 28, 30, 0.8);
border: 2px solid #3a3a3c;
border-radius: 12px;
padding: 12px 14px;
backdrop-filter: blur(20px);
transition: all 0.3s ease;
}

.input:focus-within {
border-color: var(–purple);
box-shadow: 0 0 0 3px rgba(191, 90, 242, 0.2);
background: rgba(28, 28, 30, 0.95);
}

.input input {
flex: 1;
border: 0;
background: transparent;
outline: none;
color: var(–text);
font-size: 16px !important;
}

.btn {
border: 0;
border-radius: 12px;
padding: 12px 16px;
background: linear-gradient(135deg, #2c2c2e 0%, #3a3a3c 100%);
color: var(–text);
cursor: pointer;
font-weight: 600;
transition: all 0.3s ease;
white-space: nowrap;
position: relative;
overflow: hidden;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.btn::before {
content: ‘’;
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
transition: left 0.5s ease;
}

.btn:hover::before {
left: 100%;
}

.btn:hover {
background: linear-gradient(135deg, #3a3a3c 0%, #48484a 100%);
transform: translateY(-1px);
box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

.btn.mic {
background: linear-gradient(135deg, var(–purple-dark), var(–purple));
padding: 14px 18px;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
font-size: 16px;
box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
}

.btn.mic:hover {
background: linear-gradient(135deg, #5b21b6, var(–purple-dark));
box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
}

.btn.mic.listening {
background: linear-gradient(135deg, var(–red), var(–red-dark));
animation: pulse-ring 1.5s infinite;
box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
}

.btn.primary {
background: linear-gradient(135deg, var(–purple-dark), var(–purple));
box-shadow: 0 4px 16px rgba(139, 92, 246, 0.2);
}

.btn.primary:hover {
background: linear-gradient(135deg, #5b21b6, var(–purple-dark));
box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
}

.btn.success {
background: linear-gradient(135deg, var(–accent-dark), var(–accent));
box-shadow: 0 4px 16px rgba(34, 197, 94, 0.2);
}

.btn.success:hover {
background: linear-gradient(135deg, #15803d, var(–accent-dark));
box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
}

.btn.danger {
background: linear-gradient(135deg, var(–red-dark), var(–red));
color: #fff;
box-shadow: 0 4px 16px rgba(239, 68, 68, 0.2);
}

.btn.danger:hover {
background: linear-gradient(135deg, #b91c1c, var(–red-dark));
box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
}

.settings-btn {
background: linear-gradient(135deg, var(–purple-dark), var(–purple));
border: none;
border-radius: 12px;
padding: 12px;
cursor: pointer;
color: white;
transition: all 0.3s ease;
box-shadow: 0 4px 16px rgba(139, 92, 246, 0.2);
position: relative;
overflow: hidden;
}

.settings-btn:hover {
background: linear-gradient(135deg, #5b21b6, var(–purple-dark));
transform: translateY(-2px) rotate(90deg);
box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
}

/* Actions Panel */
#actions-panel {
max-height: 0;
opacity: 0;
overflow: hidden;
transition: max-height 0.4s ease-out, opacity 0.3s ease-in, margin-top 0.4s ease-out;
margin-top: 0;
position: relative;
z-index: 2;
background: rgba(42, 42, 46, 0.8);
border-radius: 16px;
backdrop-filter: blur(20px);
}

#actions-panel.open {
max-height: 300px;
opacity: 1;
margin-top: 12px;
padding: 16px;
border: 1px solid rgba(255, 255, 255, 0.1);
}

#toggleActionsBtn {
width: 100%;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
background: linear-gradient(135deg, var(–purple-dark), var(–purple));
box-shadow: 0 4px 16px rgba(139, 92, 246, 0.2);
}

#toggleActionsBtn:hover {
background: linear-gradient(135deg, #5b21b6, var(–purple-dark));
box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
}

#toggleActionsBtn .icon {
transition: transform 0.3s ease-in-out;
}

#toggleActionsBtn.open .icon {
transform: rotate(45deg);
}

/* List Styles */
.list {
display: flex;
flex-direction: column;
gap: 12px;
align-items: center;
justify-content: flex-start;
width: 100%;
}

.list-item {
background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2e 100%);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 16px;
padding: 16px 18px;
display: flex;
align-items: center;
justify-content: space-between;
transition: all 0.3s ease;
width: 100%;
position: relative;
z-index: 1;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
backdrop-filter: blur(20px);
}

.list-item:hover {
transform: translateY(-2px);
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
border-color: rgba(191, 90, 242, 0.3);
background: linear-gradient(135deg, #1f1f1f 0%, #333333 100%);
}

.list-item-content {
flex-grow: 1;
}

.list-item-plate {
font-family: ‘SF Mono’, ‘Monaco’, ‘Inconsolata’, ‘Roboto Mono’, monospace;
font-weight: 800;
font-size: 1.3rem;
color: var(–text);
text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

.list-item-location {
font-size: 0.9rem;
color: var(–muted);
margin-top: 4px;
}

.list-item-location.foyer {
color: var(–red);
font-weight: 700;
}

.list-item-badge {
padding: 5px 10px;
border-radius: 9999px;
font-weight: 600;
font-size: 12px;
}

.list-item-badge.success {
background: linear-gradient(135deg, #14532d, var(–accent-dark));
color: #bbf7d0;
box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
}

.list-item-right {
display: flex;
align-items: center;
gap: 16px;
}

/* Vehicle Display - Fixed Centering */
.car-plate-display {
position: relative;
overflow: hidden;
border-radius: 20px;
text-align: center;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 2rem 1.5rem;
width: 100%;
max-width: 500px;
margin: 0 auto;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6),
inset 0 2px 4px rgba(255, 255, 255, 0.1);
backdrop-filter: blur(20px);
}

.car-plate-display-cleared {
background: linear-gradient(135deg, #007aff 0%, #0056cc 50%, #004499 100%);
border: 4px solid #ffd60a;
box-shadow: 0 20px 80px rgba(0, 122, 255, 0.4),
0 0 0 1px rgba(255, 214, 10, 0.3);
}

.car-plate-display-not-found {
background: linear-gradient(135deg, #ff453a 0%, #d70015 50%, #aa0011 100%);
border: 4px solid var(–red-dark);
box-shadow: 0 20px 80px rgba(255, 69, 58, 0.4),
0 0 0 1px rgba(215, 0, 21, 0.3);
}

.car-plate-display::before {
content: ‘’;
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
animation: shine 4s infinite;
}

.car-plate-text {
font-family: ‘SF Mono’, ‘Monaco’, ‘Inconsolata’, ‘Roboto Mono’, monospace;
font-weight: 900;
text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
letter-spacing: 6px;
color: white !important;
font-size: clamp(2rem, 8vw, 3.5rem);
text-align: center;
margin-bottom: 1rem;
}

.plate-status-badge {
display: inline-flex;
align-items: center;
padding: 0.75rem 1.5rem;
border-radius: 50px;
font-size: 1rem;
font-weight: 800;
text-transform: uppercase;
letter-spacing: 1px;
box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
backdrop-filter: blur(10px);
}

.plate-status-badge.success {
background: linear-gradient(135deg, var(–accent-dark), var(–accent));
color: white;
border: 2px solid rgba(255, 255, 255, 0.2);
}

.plate-status-badge.error {
background: linear-gradient(135deg, var(–red-dark), var(–red));
color: white;
border: 2px solid rgba(255, 255, 255, 0.2);
}

.search-highlight {
color: white !important;
background: none !important;
animation: glow 2s ease-in-out infinite alternate;
text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
}

.exit-btn {
position: absolute;
top: 12px;
right: 12px;
background: rgba(0,0,0,0.5);
border: none;
cursor: pointer;
color: var(–muted);
padding: 8px;
border-radius: 50%;
transition: all 0.3s ease;
z-index: 10;
backdrop-filter: blur(10px);
}

.exit-btn:hover {
background: rgba(255, 255, 255, 0.2);
color: var(–text);
transform: scale(1.1);
}

.exit-btn svg {
width: 28px;
height: 28px;
display: block;
}

/* Dropdown */
.dropdown-container {
position: relative;
}

.more-btn {
background: none;
border: none;
border-radius: 50%;
padding: 6px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
color: var(–muted);
transition: all 0.3s ease;
}

.more-btn:hover {
background-color: #334155;
color: var(–text);
transform: scale(1.1);
}

.more-btn svg {
width: 20px;
height: 20px;
}

.dropdown-menu {
display: none;
position: absolute;
top: 100%;
right: 0;
background: linear-gradient(135deg, #334155, #475569);
border: 1px solid var(–outline);
border-radius: 8px;
padding: 8px;
z-index: 10;
min-width: 120px;
box-shadow: 0 8px 32px rgba(0,0,0,0.3);
backdrop-filter: blur(10px);
}

.dropdown-menu.show {
display: block;
animation: dropdownFadeIn 0.2s ease-out;
}

.dropdown-item {
display: block;
width: 100%;
text-align: left;
background: none;
border: none;
color: var(–text);
padding: 8px 12px;
border-radius: 6px;
cursor: pointer;
font-size: 14px;
white-space: nowrap;
transition: all 0.2s ease;
}

.dropdown-item:hover {
background-color: #475569;
transform: translateX(2px);
}

.dropdown-item.danger {
color: var(–red);
}

.dropdown-item.danger:hover {
background-color: var(–red-dark);
color: white;
}

/* Modals - Dark Theme */
.modal-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.8);
z-index: 1000;
justify-content: center;
align-items: center;
backdrop-filter: blur(20px);
}

.modal-overlay.visible {
display: flex;
animation: fadeInModal 0.2s ease-out;
}

.modal-panel {
background: linear-gradient(135deg, #1a1a1a, #2c2c2e);
border: 2px solid rgba(255, 255, 255, 0.1);
border-radius: 20px;
padding: 24px;
width: 90%;
max-width: 600px;
box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
backdrop-filter: blur(40px);
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.modal-header h2 {
margin: 0;
font-size: 20px;
}

.close-btn {
background: none;
border: none;
font-size: 24px;
color: var(–muted);
cursor: pointer;
transition: all 0.3s ease;
padding: 4px;
border-radius: 50%;
}

.close-btn:hover {
color: var(–text);
background: rgba(255,255,255,0.1);
transform: scale(1.1);
}

.form-group {
margin-bottom: 16px;
}

.form-group label {
display: block;
margin-bottom: 8px;
font-size: 14px;
color: var(–muted);
}

.modal-input {
width: 100%;
background: var(–panel);
border: 2px solid #475569;
border-radius: 12px;
padding: 12px 14px;
color: var(–text);
font-size: 16px;
text-transform: uppercase;
transition: all 0.3s ease;
}

.modal-input:focus {
border-color: var(–purple);
box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
outline: none;
}

.modal-footer {
margin-top: 24px;
display: flex;
justify-content: flex-end;
gap: 12px;
}

.api-key-input, .prompt-area {
background: var(–panel);
border: 2px solid #475569;
border-radius: 12px;
padding: 12px 14px;
transition: all 0.3s ease;
}

.api-key-input:focus-within, .prompt-area:focus-within {
border-color: var(–purple);
box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
}

.api-key-input input, .prompt-area textarea {
width: 100%;
border: 0;
background: transparent;
outline: none;
color: var(–text);
font-size: 16px;
font-family: ‘Inter’, system-ui, sans-serif;
}

.prompt-area {
margin-top: 12px;
}

.prompt-area textarea {
height: 200px;
resize: vertical;
font-size: 14px;
}

/* Notifications */
.notification {
position: fixed;
bottom: 20px;
left: 50%;
transform: translateX(-50%);
padding: 12px 24px;
border-radius: 8px;
color: white;
font-weight: 600;
z-index: 1001;
opacity: 0;
transition: opacity 0.3s, transform 0.3s;
pointer-events: none;
}

.notification.show {
opacity: 1;
transform: translateX(-50%) translateY(-20px);
}

.notification.success { background-color: var(–accent-dark); }
.notification.error { background-color: var(–red); }
.notification.info { background-color: var(–yellow); }

.hint {
color: var(–muted);
font-size: 12px;
text-align: center;
}

.animate-fade-in {
animation: fadeIn 0.3s ease-out forwards;
}

.card {
background: var(–panel);
border: 1px solid var(–outline);
border-radius: 16px;
padding: 16px;
position: relative;
}

/* Animations */
@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInModal {
from { opacity: 0; }
to { opacity: 1; }
}

@keyframes pulse-ring {
0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}

@keyframes shine {
0% { left: -100%; }
100% { left: 100%; }
}

@keyframes glow {
from { filter: drop-shadow(0 0 5px #fbbf24); }
to { filter: drop-shadow(0 0 15px #f59e0b); }
}

@keyframes glow-red {
from { filter: drop-shadow(0 0 5px var(–red)); }
to { filter: drop-shadow(0 0 15px var(–red-dark)); }
}

@keyframes weatherGlow {
from { transform: rotate(0deg) scale(1); }
to { transform: rotate(180deg) scale(1.05); }
}

@keyframes iconFloat {
0%, 100% { transform: translateY(0px); }
50% { transform: translateY(-5px); }
}

@keyframes dotPulse {
0%, 100% { transform: scale(1); opacity: 1; }
50% { transform: scale(1.2); opacity: 0.8; }
}

@keyframes searchSweep {
0% { left: -100%; }
50% { left: 100%; }
100% { left: -100%; }
}

@keyframes dropdownFadeIn {
from { opacity: 0; transform: translateY(-10px) scale(0.95); }
to { opacity: 1; transform: translateY(0) scale(1); }
}

</style>
</head>
<body>

  <!-- Settings Modal -->

  <div id="settingsModal" class="modal-overlay">
    <div class="modal-panel">
      <div class="modal-header">
        <h2>API Settings</h2>
        <button class="close-btn" data-close-modal>&times;</button>
      </div>
      <div class="modal-content">
        <label for="apiKeyInput" class="subtitle">Gemini API Key</label>
        <div class="api-key-input" style="margin-top: 8px;">
            <input type="password" id="apiKeyInput" placeholder="Paste your Gemini API Key here">
        </div>
        <label for="geminiPrompt" class="subtitle" style="display: block; margin-top: 16px;">Gemini Prompt</label>
        <div class="prompt-area">
          <textarea id="geminiPrompt" placeholder="Enter your prompt for the Gemini API here..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Vehicle Modal -->

  <div id="vehicleModal" class="modal-overlay">
    <div class="modal-panel">
      <form id="vehicleForm">
        <div class="modal-header">
          <h2 id="vehicleModalTitle">Add Vehicle</h2>
          <button type="button" class="close-btn" data-close-modal>&times;</button>
        </div>
        <div class="modal-content">
          <input type="hidden" id="vehicleId">
          <div class="form-group">
            <label for="vehicleNumberInput">Vehicle Number</label>
            <input type="text" id="vehicleNumberInput" class="modal-input" required>
          </div>
          <div class="form-group">
            <label for="locationInput">Location</label>
            <input type="text" id="locationInput" class="modal-input">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" data-close-modal>Cancel</button>
          <button type="submit" class="btn primary">Save Vehicle</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirmation Modal -->

  <div id="confirmModal" class="modal-overlay">
    <div class="modal-panel">
        <div class="modal-header">
          <h2 id="confirmModalTitle">Are you sure?</h2>
        </div>
        <div class="modal-content">
          <p id="confirmModalText">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" id="confirmCancelBtn">Cancel</button>
          <button type="button" class="btn danger" id="confirmOkBtn">Confirm</button>
        </div>
    </div>
  </div>

  <div class="wrap">
    <div class="sticky-header">
      <header>
        <div class="header-left">
          <h1>Vehicle Listings</h1>
          <div class="subtitle">Synced with Master Database</div>
        </div>
        <button id="settingsBtn" class="settings-btn" title="API Settings">
         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path d="M19.43,12.98c0.04-0.32,0.07-0.64,0.07-0.98s-0.03-0.66-0.07-0.98l2.11-1.65c0.19-0.15,0.24-0.42,0.12-0.64l-2-3.46 c-0.12-0.22-0.39-0.3-0.61-0.22l-2.49,1c-0.52-0.4-1.08-0.73-1.69-0.98l-0.38-2.65C14.46,2.18,14.25,2,14,2h-4 c-0.25,0-0.46,0.18-0.49,0.42L9.13,5.07c-0.61,0.25-1.17,0.59-1.69,0.98l-2.49-1c-0.23-0.09-0.49,0-0.61,0.22l-2,3.46 c-0.13,0.22-0.07,0.49,0.12,0.64l2.11,1.65C4.57,11.34,4.54,11.66,4.54,12s0.03,0.66,0.07,0.98l-2.11,1.65 c-0.19,0.15-0.24-0.42-0.12,0.64l2,3.46c0.12,0.22,0.39,0.3,0.61,0.22l2.49-1c0.52,0.4,1.08,0.73,1.69,0.98l0.38,2.65 C9.54,21.82,9.75,22,10,22h4c0.25,0,0.46-0.18,0.49-0.42l0.38-2.65c0.61-0.25,1.17-0.59,1.69,0.98l2.49,1 c0.23,0.09,0.49,0,0.61,0.22l2-3.46c0.12-0.22,0.07-0.49-0.12-0.64L19.43,12.98z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3 s3,1.34,3,3S13.66,15,12,15z"/>
          </svg>
        </button>
      </header>

```
  <!-- Enhanced Search Panel -->
  <div class="search-panel">
    <div class="search-header">
      <div class="search-title">
        🚗 Vehicle Search
        <span class="vehicle-count-badge" id="vehicleCountBadge">0 vehicles</span>
      </div>
      <div class="search-time" id="currentTime">09:53</div>
    </div>

    <!-- Action Toggler -->
    <button class="btn" id="toggleActionsBtn">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      </span>
      <span id="toggleActionsText">Actions</span>
    </button>

    <!-- Collapsible Panel for Buttons -->
    <div id="actions-panel">
        <div class="row">
          <button class="btn primary" id="addVehicleBtn">Add Vehicle</button>
          <label class="btn success">
            <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none">
            Import CSV
          </label>
          <label class="btn" style="background: linear-gradient(135deg, var(--purple), #a855f7);">
            <input id="geminiImageFile" type="file" accept="image/*" style="display:none">
            Import with API
          </label>
          <button class="btn" id="exportBtn">Export CSV</button>
          <button class="btn danger" id="clearListBtn">Clear List</button>
        </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="input"><input id="searchBox" placeholder="Search Vehicle..." inputmode="numeric" autocomplete="off"></div>
      <button class="btn mic" id="micBtn" title="Voice search">🎤 Voice</button>
      <button class="btn" id="clearSearchBtn">Clear Search</button>
    </div>
    <div class="row" style="margin-top: 12px;">
      <span id="count" class="subtitle" style="flex:1; text-align:left;">0 rows</span>
    </div>
  </div>
</div>

<div class="scroll-content">
  <div id="list" class="list"></div>
  <div id="empty" class="hint" style="padding: 40px 0;">
      Connecting to database...<br>
      If this persists, check your internet connection or firewall settings.
  </div>
</div>
```

  </div>

<script type="module">
  // Firebase Integration
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC51Zo7V75JjOpLOdusf6ZKUzEG_gqFcV4",
    authDomain: "vehicle-clearance.firebaseapp.com",
    projectId: "vehicle-clearance",
    storageBucket: "vehicle-clearance.appspot.com",
    messagingSenderId: "187403368572",
    appId: "1:187403368572:web:1f94845da67ef0c7ccf1f9"
  };

  let app, auth, db, listingsCollection;
  const LISTINGS_COLLECTION_NAME = 'vehicleListings';

  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  } catch (err) {
    console.error("Firebase initialization error:", err);
    showNotification("Could not connect to the database.", "error");
  }

  // Time Display
  function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
      hour12: false, 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    document.getElementById('currentTime').textContent = timeString;
  }

  setInterval(updateTime, 1000);
  updateTime();

  // Vehicle Count Badge Update
  function updateVehicleCount() {
    const badge = document.getElementById('vehicleCountBadge');
    const count = allRows.length;
    badge.textContent = `${count} vehicle${count !== 1 ? 's' : ''}`;
  }

  // Voice Search Implementation
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const playBeep = (frequency = 440, duration = 100, type = 'sine') => {
      if (!audioContext) return;
      try {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          oscillator.type = type;
          oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration / 1000);
          oscillator.start();
          oscillator.stop(audioContext.currentTime + duration / 1000);
      } catch (error) {
          console.error("Beep playback failed:", error);
      }
  };

  let recognition = null;
  let isVoiceSearchActive = false;
  let voiceSearchTimeout = null;
  const searchBox = document.getElementById('searchBox');
  const micBtn = document.getElementById('micBtn');

  const initializeVoiceRecognition = () => {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          console.warn('Speech recognition not supported');
          return false;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onstart = () => {
          isVoiceSearchActive = true;
          if (micBtn) micBtn.classList.add('listening');
      };
      recognition.onresult = (event) => handleVoiceResult(event);
      recognition.onerror = (event) => {
          let errorMessage = 'An error occurred during voice recognition.';
          if (event.error === 'no-speech') errorMessage = 'No speech detected. Please try again.';
          else if (event.error === 'not-allowed') errorMessage = 'Microphone permission denied.';
          showNotification(errorMessage, 'error');
          stopVoiceSearch();
      };
      recognition.onend = () => {
          if (isVoiceSearchActive) stopVoiceSearch();
      };
      return true;
  };

  const processVehicleNumber = (spokenText) => {
      let processed = spokenText.toLowerCase().trim();
      const fillerWords = ['um', 'uh', 'the', 'number', 'is', 'vehicle', 'car', 'plate'];
      fillerWords.forEach(word => {
          processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), ' ');
      });
      const numberMappings = [
          ['zero', '0'], ['oh', '0'], ['o', '0'], ['one', '1'], ['won', '1'], 
          ['two', '2'], ['to', '2'], ['too', '2'], ['three', '3'], ['tree', '3'],
          ['four', '4'], ['for', '4'], ['fore', '4'], ['five', '5'], ['fife', '5'],
          ['six', '6'], ['sex', '6'], ['seven', '7'], ['sven', '7'],
          ['eight', '8'], ['ate', '8'], ['nine', '9'], ['nein', '9']
      ];
      numberMappings.forEach(([word, digit]) => {
          processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), ` ${digit} `);
      });
      const digitMatches = processed.match(/\d+/g);
      return digitMatches ? digitMatches.join('') : '';
  };

  const isValidSearchTerm = (searchTerm) => {
      if (!searchTerm) return false;
      if (searchTerm.length < 1 || searchTerm.length > 8) return false;
      return /^\d+$/.test(searchTerm);
  };

  const handleVoiceResult = (event) => {
      let transcript = event.results[0][0].transcript;
      let detectedNumber = processVehicleNumber(transcript);
      if (isValidSearchTerm(detectedNumber)) {
          completeVoiceSearch(detectedNumber);
      } else {
          showNotification(`Could not detect a valid number from "${transcript}"`, 'error');
          stopVoiceSearch();
      }
  };

  const startVoiceSearch = () => {
      if (!recognition) {
          if (!initializeVoiceRecognition()) {
              showNotification("Voice search not supported on this device", "error");
              return;
          }
      }
      if (isVoiceSearchActive) {
          stopVoiceSearch();
          return;
      }
      try {
          playBeep(523, 150);
          recognition.start();
          voiceSearchTimeout = setTimeout(() => {
              showNotification("Voice search timed out.", "error");
              stopVoiceSearch();
          }, 8000);
      } catch (error) {
          showNotification("Failed to start voice search", "error");
      }
  };

  const stopVoiceSearch = () => {
      if (!isVoiceSearchActive) return;
      playBeep(392, 150);
      if (recognition) recognition.stop();
      if (voiceSearchTimeout) clearTimeout(voiceSearchTimeout);
      if (micBtn) micBtn.classList.remove('listening');
      isVoiceSearchActive = false;
      voiceSearchTimeout = null;
  };

  const completeVoiceSearch = (detectedNumber) => {
      if (searchBox && detectedNumber) {
          searchBox.value = detectedNumber;
          searchBox.dispatchEvent(new Event('input', { bubbles: true }));
      }
      stopVoiceSearch();
  };

  // CSV, Gemini API, and List Management
  const API_KEY_STORAGE_KEY = 'geminiApiKey';
  let allRows = [];
  let filtered = [];
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const countEl = document.getElementById('count');
  
  // Modal Elements
  const settingsModal = document.getElementById('settingsModal');
  const vehicleModal = document.getElementById('vehicleModal');
  const confirmModal = document.getElementById('confirmModal');
  const settingsBtn = document.getElementById('settingsBtn');
  const geminiPromptEl = document.getElementById('geminiPrompt');
  const apiKeyInput = document.getElementById('apiKeyInput');
  const vehicleForm = document.getElementById('vehicleForm');

  function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
          notification.classList.add('show');
      }, 10);
      setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
              notification.remove();
          }, 300);
      }, 4000);
  }

  function normalizePlate(s){
    return (s||'').toString().toUpperCase().replace(/\s+/g,'').replace(/O/g,'0').replace(/[^A-Z0-9]/g,'');
  }

  function joinFromColumns(row){
    let plate = row.vehicleNumber || row.VehicleNumber || row.plate || row.Plate;
    if(plate) return normalizePlate(plate);
    const code = row.Code || row.code;
    const num = row.Number || row.number;
    const suffix = row.Suffix || row.suffix;
    if(code && num) return normalizePlate(`${code}${num}${suffix || ''}`);
    return '';
  }
  
  function parseCsvText(text) {
      const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
      if (lines.length < 2) return [];
      
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const locationHeader = headers.find(h => h.toLowerCase() === 'location');
      const vehicleNumberHeader = headers.find(h => h.toLowerCase().replace(/\s/g,'') === 'vehiclenumber');

      const newRows = [];
      for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
          const row = Object.fromEntries(headers.map((h, idx) => [h, cols[idx] || '']));
          const plate = vehicleNumberHeader ? row[vehicleNumberHeader] : joinFromColumns(row);
          const location = locationHeader ? row[locationHeader] : 'N/A';
          if (plate) newRows.push({ vehicleNumber: normalizePlate(plate), location: location.toUpperCase() });
      }
      return newRows;
  }

  function render() {
    const searchTerm = searchBox.value.trim().toUpperCase();
    listEl.innerHTML = '';
    const scrollContent = document.querySelector('.scroll-content');

    scrollContent.classList.remove('is-centered');

    if (allRows.length === 0) {
        emptyEl.style.display = 'block';
        listEl.style.display = 'block'; 
        countEl.textContent = '0 rows';
        emptyEl.innerHTML = 'No vehicles in this list. Add one or import a file.';
        return;
    }

    const isSingleResultView = searchTerm && (filtered.length === 1 || filtered.length === 0);

    if (isSingleResultView) {
        scrollContent.classList.add('is-centered');
    }

    if (searchTerm && filtered.length === 0) {
        emptyEl.style.display = 'none';
        listEl.style.display = 'flex';
        scrollContent.classList.add('is-centered');
        countEl.textContent = `0 matches found for "${searchTerm}"`;
        listEl.innerHTML = `
            <div class="animate-fade-in" style="width: 100%; max-width: 500px;">
                <div class="car-plate-display car-plate-display-not-found" style="margin-bottom: 24px;">
                    <div class="car-plate-text">
                        <span class="search-highlight" style="animation-name: glow-red;">${searchTerm}</span>
                    </div>
                    <div class="plate-status-badge error">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/></svg>
                        NOT FOUND
                    </div>
                </div>
                <div class="card animate-fade-in" style="padding: 32px; width: 100%; background: linear-gradient(135deg, #1a1a1a, #2c2c2e); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                    <button id="exitSingleViewBtn" class="exit-btn" title="Back to list">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                    <div style="text-align: center;">
                        <h3 style="font-size: 1.5rem; font-weight: 800; color: var(--red); margin-bottom: 16px;">ACCESS DENIED</h3>
                        <p style="margin-top: 8px; color: var(--muted); font-size: 1.1rem;">Vehicle <strong style="color: var(--text);">${searchTerm}</strong> is not on the current list.</p>
                    </div>
                </div>
            </div>`;

        document.getElementById('exitSingleViewBtn').addEventListener('click', () => {
            searchBox.value = '';
            applyFilter();
        });
        return;
    }

    emptyEl.style.display = 'none';
    listEl.style.display = 'flex';
    countEl.textContent = `Showing ${filtered.length} of ${allRows.length} rows`;

    if (searchTerm && filtered.length === 1) {
        scrollContent.classList.add('is-centered');
        const c = filtered[0];
        const plateHTML = `
            <div class="animate-fade-in" style="width: 100%; max-width: 500px;">
                <div class="car-plate-display car-plate-display-cleared animate-fade-in" style="margin-bottom: 24px;">
                    <div class="car-plate-text">
                        <span class="search-highlight">${c.vehicleNumber}</span>
                    </div>
                    <div class="plate-status-badge success">
                        ✓ CLEARED
                    </div>
                </div>
                <div class="card animate-fade-in" style="padding: 32px; width: 100%; background: linear-gradient(135deg, #1a1a1a, #2c2c2e); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                    <button id="exitSingleViewBtn" class="exit-btn" title="Back to list">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                    <div style="text-align: center;">
                        <p style="font-size: 0.875rem; color: var(--muted); text-transform: uppercase; font-weight: 600; margin-bottom: 12px; letter-spacing: 2px;">LOCATION</p>
                        <p style="font-weight: 800; font-size: 2rem; ${ (c.location && c.location.toLowerCase() === 'foyer') ? 'color: var(--red);' : 'color: var(--text);'} text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${c.location || 'N/A'}</p>
                    </div>
                </div>
            </div>
        `;
        listEl.innerHTML = plateHTML;

        document.getElementById('exitSingleViewBtn').addEventListener('click', () => {
            searchBox.value = '';
            applyFilter();
        });

    } else {
        const listHTML = filtered.map(c => {
            const locationText = c.location || 'N/A';
            const isFoyer = locationText.toLowerCase() === 'foyer';
            const locationClass = isFoyer ? 'list-item-location foyer' : 'list-item-location';

            return `
            <div class="list-item animate-fade-in">
                <div class="list-item-content">
                    <div class="list-item-plate">${c.vehicleNumber}</div>
                    <div class="${locationClass}">${locationText}</div>
                </div>
                <div class="list-item-right">
                    <span class="list-item-badge success">Cleared</span>
                    <div class="dropdown-container">
                        <button class="more-btn" data-dropdown-for="${c.id}" title="More options">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                        </button>
                        <div class="dropdown-menu" id="dropdown-${c.id}">
                            <button class="dropdown-item" data-action="edit" data-id="${c.id}">Edit</button>
                            <button class="dropdown-item danger" data-action="delete" data-id="${c.id}">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');
        listEl.innerHTML = listHTML;
    }
    
    updateVehicleCount();
  }

  function applyFilter(){
    const term = searchBox.value.trim().toUpperCase();
    let tempFiltered;
    if (!term) {
        tempFiltered = [...allRows];
    } else {
        tempFiltered = allRows.filter(r => {
            const numericPartOfPlate = r.vehicleNumber.replace(/[^0-9]/g, '');
            return numericPartOfPlate.startsWith(term);
        });
    }

    tempFiltered.sort((a, b) => {
        const aIsFoyer = a.location && a.location.toLowerCase() === 'foyer';
        const bIsFoyer = b.location && b.location.toLowerCase() === 'foyer';

        if (aIsFoyer && !bIsFoyer) return -1;
        if (!aIsFoyer && bIsFoyer) return 1;
        
        return a.vehicleNumber.localeCompare(b.vehicleNumber);
    });

    filtered = tempFiltered;
    render();
  }
  
  // Gemini API Implementation
  const fileToGenerativePart = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64Data = reader.result.split(',')[1];
        resolve({
          inlineData: {
            mimeType: file.type,
            data: base64Data
          }
        });
      };
      reader.onerror = (err) => reject(err);
      reader.readAsDataURL(file);
    });
  };

  document.getElementById('geminiImageFile').addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const apiKey = apiKeyInput.value.trim();
    if (!apiKey) {
        showNotification('Please set your Gemini API Key in the settings panel first.', 'error');
        e.target.value = '';
        return;
    }

    const prompt = geminiPromptEl.value;
    if (!prompt) {
        showNotification('Please enter a prompt in the settings panel.', 'error');
        e.target.value = '';
        return;
    }

    showNotification('Processing with Gemini API...', 'info');

    try {
        const imagePart = await fileToGenerativePart(file);
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{
                parts: [
                    { text: prompt },
                    imagePart
                ]
            }]
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
        }

        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!text) {
            throw new Error('No text returned from API.');
        }
        
        const cleanedText = text.replace(/```csv\n|```/g, '').trim();
        const newRows = parseCsvText(cleanedText);

        if (newRows.length === 0) {
            showNotification('Gemini could not extract valid data. Check the prompt and image.', 'error');
            return;
        }
        
        const batch = writeBatch(db);
        newRows.forEach(row => {
            const docRef = doc(listingsCollection);
            batch.set(docRef, row);
        });
        await batch.commit();

        searchBox.value = '';
        showNotification(`Successfully imported ${newRows.length} vehicles via Gemini.`, 'success');

    } catch (error) {
        console.error('Gemini API Error:', error);
        showNotification(error.message, 'error');
    } finally {
        e.target.value = '';
    }
  });

  // CSV and Event Listener Code
  document.getElementById('csvFile').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const text = await file.text();
    const newRows = parseCsvText(text);

    if (newRows.length === 0) {
        showNotification('Could not find valid vehicle numbers in the CSV.', 'error');
        return;
    }

    const batch = writeBatch(db);
    newRows.forEach(row => {
        const docRef = doc(listingsCollection);
        batch.set(docRef, row);
    });
    await batch.commit();
    
    searchBox.value = '';
    showNotification(`Successfully imported ${newRows.length} vehicles from CSV.`, 'success');
    e.target.value = '';
  });
  
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    if(!allRows.length){ showNotification('Nothing to export.', 'error'); return; }
    const csv = 'vehicleNumber,location,status\n' + allRows.map(r => `"${r.vehicleNumber}","${r.location || 'N/A'}","Cleared"`).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'vehicle_listings_export.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  });
  
  document.getElementById('clearListBtn').addEventListener('click', () => {
      showConfirmModal('Clear Entire List?', 'Are you sure you want to permanently delete all vehicles in this list from the database?', async () => {
          const snapshot = await getDocs(listingsCollection);
          const batch = writeBatch(db);
          snapshot.docs.forEach(d => batch.delete(d.ref));
          await batch.commit();
          showNotification('List has been cleared from the database.', 'success');
      });
  });

  searchBox.addEventListener('input', ()=>{ 
    if(window.__t) clearTimeout(window.__t); 
    window.__t = setTimeout(applyFilter, 120); 
  });

  document.getElementById('clearSearchBtn').addEventListener('click', ()=>{ 
    searchBox.value=''; 
    applyFilter(); 
  });

  micBtn.addEventListener('click', startVoiceSearch);

  // Modal Logic
  function showConfirmModal(title, text, onConfirm) {
      document.getElementById('confirmModalTitle').textContent = title;
      document.getElementById('confirmModalText').textContent = text;
      confirmModal.classList.add('visible');

      const confirmOkBtn = document.getElementById('confirmOkBtn');
      const confirmCancelBtn = document.getElementById('confirmCancelBtn');

      const handleConfirm = () => {
          onConfirm();
          hideConfirmModal();
          cleanup();
      };
      
      const handleCancel = () => {
          hideConfirmModal();
          cleanup();
      };

      const cleanup = () => {
          confirmOkBtn.removeEventListener('click', handleConfirm);
          confirmCancelBtn.removeEventListener('click', handleCancel);
      };

      confirmOkBtn.addEventListener('click', handleConfirm);
      confirmCancelBtn.addEventListener('click', handleCancel);
  }

  function hideConfirmModal() {
      confirmModal.classList.remove('visible');
  }

  document.querySelectorAll('[data-close-modal]').forEach(el => {
    el.addEventListener('click', () => {
      el.closest('.modal-overlay').classList.remove('visible');
    });
  });

  document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('visible');
      }
    });
  });

  // Add/Edit/Delete Logic
  document.getElementById('addVehicleBtn').addEventListener('click', () => {
    vehicleForm.reset();
    document.getElementById('vehicleModalTitle').textContent = 'Add Vehicle';
    document.getElementById('vehicleId').value = '';
    vehicleModal.classList.add('visible');
    document.getElementById('vehicleNumberInput').focus();
  });
  
  async function handleAction(action, docId) {
      if (action === 'edit') {
          const vehicle = allRows.find(r => r.id === docId);
          if (vehicle) {
              vehicleForm.reset();
              document.getElementById('vehicleModalTitle').textContent = 'Edit Vehicle';
              document.getElementById('vehicleId').value = vehicle.id;
              document.getElementById('vehicleNumberInput').value = vehicle.vehicleNumber;
              document.getElementById('locationInput').value = vehicle.location || '';
              vehicleModal.classList.add('visible');
          }
      } else if (action === 'delete') {
          const vehicle = allRows.find(r => r.id === docId);
          if(vehicle) {
            showConfirmModal(
                `Delete ${vehicle.vehicleNumber}?`, 
                'This vehicle will be permanently removed from the database.',
                async () => {
                    await deleteDoc(doc(db, LISTINGS_COLLECTION_NAME, docId));
                    showNotification(`Vehicle ${vehicle.vehicleNumber} deleted.`, 'success');
                }
            );
          }
      }
  }

  vehicleForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const docId = document.getElementById('vehicleId').value;
    const newPlate = normalizePlate(document.getElementById('vehicleNumberInput').value);
    const newLocation = document.getElementById('locationInput').value.trim().toUpperCase();

    if (!newPlate) {
        showNotification('Vehicle number cannot be empty.', 'error');
        return;
    }

    const isEditing = !!docId;
    
    const plateExists = allRows.some(r => r.vehicleNumber === newPlate && r.id !== docId);
    if (plateExists) {
        showNotification(`Vehicle number ${newPlate} already exists.`, 'error');
        return;
    }

    const vehicleData = { vehicleNumber: newPlate, location: newLocation };

    try {
        if (isEditing) {
            await setDoc(doc(db, LISTINGS_COLLECTION_NAME, docId), vehicleData);
            showNotification(`Vehicle updated.`, 'success');
        } else {
            await addDoc(listingsCollection, vehicleData);
            showNotification(`Vehicle ${newPlate} added.`, 'success');
        }
        vehicleModal.classList.remove('visible');
    } catch (error) {
        console.error("Firestore save error:", error);
        showNotification("Error saving vehicle to the database.", "error");
    }
  });

  // Dropdown and Action Handling
  document.addEventListener('click', (e) => {
    const moreBtn = e.target.closest('.more-btn');
    const dropdownItem = e.target.closest('.dropdown-item');

    const openDropdowns = document.querySelectorAll('.dropdown-menu.show');
    
    openDropdowns.forEach(dropdown => {
        if (dropdown !== (moreBtn ? moreBtn.closest('.dropdown-container').querySelector('.dropdown-menu') : null)) {
            dropdown.classList.remove('show');
            dropdown.closest('.list-item')?.classList.remove('dropdown-active');
        }
    });

    if (moreBtn) {
        const docId = moreBtn.dataset.dropdownFor;
        const dropdown = document.getElementById(`dropdown-${docId}`);
        const listItem = moreBtn.closest('.list-item');
        if (dropdown && listItem) {
            dropdown.classList.toggle('show');
            listItem.classList.toggle('dropdown-active');
        }
    }

    if (dropdownItem) {
        const action = dropdownItem.dataset.action;
        const docId = dropdownItem.dataset.id;
        handleAction(action, docId);
    }
  });

  // Settings Modal Logic
  settingsBtn.addEventListener('click', () => {
    settingsModal.classList.add('visible');
  });

  document.querySelector('#settingsModal .close-btn').addEventListener('click', () => {
    const apiKey = apiKeyInput.value.trim();
    if (apiKey) {
      localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
      showNotification('API Key saved.', 'info');
    }
  });

  // Actions Toggler Logic
  const toggleActionsBtn = document.getElementById('toggleActionsBtn');
  const actionsPanel = document.getElementById('actions-panel');
  const toggleActionsText = document.getElementById('toggleActionsText');

  toggleActionsBtn.addEventListener('click', () => {
    const isOpen = actionsPanel.classList.toggle('open');
    toggleActionsBtn.classList.toggle('open');
    toggleActionsText.textContent = isOpen ? 'Close' : 'Actions';
  });

  // Initial setup
  onAuthStateChanged(auth, user => {
    if (user) {
        console.log("Authenticated anonymously:", user.uid);
        listingsCollection = collection(db, LISTINGS_COLLECTION_NAME);
        
        onSnapshot(listingsCollection, (snapshot) => {
            allRows = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            applyFilter();
            showNotification("Data synced with the database.", "info");
        }, (error) => {
            console.error("Firestore snapshot error:", error);
            showNotification("Error syncing with the database.", "error");
        });
    } else {
        signInAnonymously(auth).catch((error) => {
            console.error("Anonymous sign-in failed:", error);
            showNotification("Authentication with the database failed.", "error");
        });
    }
  });

  window.addEventListener('load', () => {
      // Apple Watch Ultra scrolling optimizations
      if (navigator.userAgent.includes("Watch") || window.screen.width <= 500) {
        document.body.style.overflow = 'auto';
        document.body.style.height = 'auto';
        
        const wrap = document.querySelector('.wrap');
        if (wrap) wrap.style.height = 'auto';
        
        const scrollContent = document.querySelector('.scroll-content');
        if (scrollContent) scrollContent.style.overflowY = 'visible';
      }

      // Initialize voice recognition
      if (initializeVoiceRecognition()) {
        startVoiceSearch();
      }
      
      const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
      if (savedApiKey) {
        apiKeyInput.value = savedApiKey;
      }

      geminiPromptEl.value = `Analyze the attached image, which contains a table. Your task is to meticulously extract all the information from this table and format it as a CSV (Comma-Separated Values) text.
The first column often contains "DOC" or "OC", which should be ignored.
The primary columns to extract are for the vehicle number and the location.
Combine the separate parts of the vehicle number (e.g., "GBD", "3945", "J") into a single, normalized string like "GBD3945J".
The final columns of the table are the date and the location (e.g., "COURTYARD", "BASEMENT").
Your output should be a CSV with two headers: vehicleNumber,location

Example Input Row: DOC | GBD | 3945 | J | 13TH AUG 2025 | COURTYARD
Example Output Row: GBD3945J,COURTYARD

Please generate the full CSV data from the image now.`;
  });
</script>

</body>
</html>