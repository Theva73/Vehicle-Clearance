<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Daily Vehicle Clearances â€” Voice & Search (v2)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --text:#e5e7eb; --muted:#a7b0c8;
    --accent:#8b5cf6; --ok:#16a34a; --card:#111827; --outline:#1f2a44;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:14px 14px 60px}
  header{display:flex;flex-direction:column;gap:6px;margin:8px 0 14px}
  h1{font-size:clamp(18px,3.8vw,26px);margin:0}
  .subtitle{color:var(--muted);font-size:13px}
  .panel{background:linear-gradient(180deg,var(--panel),#0a0f1c);border:1px solid var(--outline);border-radius:14px;padding:12px 12px}
  .status{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .pill{border:1px solid #234; padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;align-items:center}
  .input{flex:1;display:flex;align-items:center;background:#0a1428;border:1px solid #2b3a5f;border-radius:12px;padding:10px 12px}
  .input input{flex:1;border:0;background:transparent;outline:none;color:var(--text);font-size:16px;min-height:20px}
  .btn{border:0;border-radius:12px;padding:10px 12px;background:#1f2937;color:#e5e7eb;border:1px solid #334155;cursor:pointer;font-weight:600}
  .btn.primary{background:#5b21b6;color:#fff;border-color:#5b21b6}
  .btn.mic{background:#6d28d9;border-color:#6d28d9;display:flex;align-items:center;gap:8px}
  .btn.mic.listening{background:#ef4444;border-color:#ef4444;animation:pulse 1.5s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}70%{box-shadow:0 0 0 15px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
  .list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .item{background:linear-gradient(180deg,#0b1220,#0a0f1b);border:1px solid #1f2a44;border-radius:12px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
  .plate{letter-spacing:0.06em;font-weight:800;color:#93c5fd}
  .badge{padding:6px 10px;border-radius:999px;background:#052e12;border:1px solid #14532d;color:#bbf7d0;font-weight:700;font-size:12px}
  .empty{color:var(--muted);text-align:center;padding:16px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .file{display:flex;align-items:center;gap:10px}
  small{color:var(--muted)}
  .notice{margin-top:8px;color:#fbbf24;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily Vehicle Clearances</h1>
      <div class="subtitle" id="dateSub">Showing vehicles cleared for today</div>
      <div class="notice" id="voiceNotice" style="display:none"></div>
    </header>

    <div class="panel">
      <div class="status actions">
        <label class="file">
          <input id="csv" type="file" accept=".csv,text/csv" />
          <span class="btn">Import CSV</span>
        </label>
        <button class="btn" id="export">Export CSV</button>
        <span class="pill" id="count">0 rows</span>
      </div>
      <div class="row" style="margin-top:6px">
        <div class="input"><input id="q" placeholder="Search Vehicle..." inputmode="latin" autocapitalize="characters" autocomplete="off"></div>
        <button class="btn mic" id="micBtn" title="Voice search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
          <span>Voice</span>
        </button>
        <button class="btn" id="clear">Clear</button>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div id="list" class="list"></div>
      <div id="empty" class="empty">No vehicles loaded yet. Import a CSV to begin.</div>
      <small>Expected CSV headers: <b>vehicleNumber</b> (or Code+Number+Suffix which will be joined as CODE####X).</small>
    </div>
  </div>

<script>
  // State
  let allRows = [];   // {vehicleNumber}
  let filtered = [];
  const q = document.getElementById('q');
  const micBtn = document.getElementById('micBtn');
  const list = document.getElementById('list');
  const empty = document.getElementById('empty');
  const count = document.getElementById('count');
  const voiceNotice = document.getElementById('voiceNotice');

  document.getElementById('dateSub').textContent = "Showing vehicles cleared for today: " + new Date().toLocaleDateString('en-GB');

  // Voice capability check
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const isHttps = location.protocol === 'https:' || location.hostname === 'localhost';
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  if(!SR){
    voiceNotice.style.display = 'block';
    voiceNotice.innerHTML = "Voice search is not supported in this browser. On iPhone/iPad, use the keyboard microphone to dictate into the search box. On Android/desktop Chrome over HTTPS it will work.";
  } else if(!isHttps){
    voiceNotice.style.display = 'block';
    voiceNotice.innerHTML = "Voice search requires HTTPS. Host this page on a secure site (e.g., GitHub Pages) to enable the mic.";
  }

  function normalizePlate(s){
    if(!s) return '';
    return s.toString().toUpperCase().replace(/\s+/g,'').replace(/O/g,'0').replace(/[^A-Z0-9]/g,'');
  }
  function joinFromColumns(row){
    let plate = row.vehicleNumber || row.VehicleNumber || row.plate || row.Plate;
    if(plate) return normalizePlate(plate);
    const code = row.Code || row.code;
    const num = row.Number || row.number;
    const suffix = row.Suffix || row.suffix;
    if(code && num && suffix) return normalizePlate(`${code}${num}${suffix}`);
    return '';
  }
  function render(){
    list.innerHTML = '';
    if(filtered.length === 0){
      empty.style.display = 'block';
      count.textContent = '0 rows';
      return;
    }
    empty.style.display = 'none';
    count.textContent = filtered.length + ' rows';
    const frag = document.createDocumentFragment();
    filtered.forEach(rec => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div class="plate">${rec.vehicleNumber}</div><span class="badge">Cleared</span>`;
      frag.appendChild(div);
    });
    list.appendChild(frag);
  }
  function applyFilter(){
    const term = normalizePlate(q.value);
    if(!term){ filtered = [...allRows]; render(); return; }
    filtered = allRows.filter(r => r.vehicleNumber.includes(term));
    render();
  }

  // CSV import
  document.getElementById('csv').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(lines.length === 0){ alert('Empty CSV'); return; }
    const headers = lines[0].split(',').map(h => h.trim());
    allRows = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(',').map(c => c.trim());
      const row = Object.fromEntries(headers.map((h,idx)=>[h, cols[idx] || '']));
      const plate = joinFromColumns(row);
      if(plate){ allRows.push({vehicleNumber: plate}); }
    }
    filtered = [...allRows];
    applyFilter();
  });

  // Export CSV
  document.getElementById('export').addEventListener('click', ()=>{
    if(allRows.length === 0){ alert('Nothing to export.'); return; }
    const csv = 'vehicleNumber,status\n' + allRows.map(r => `${r.vehicleNumber},Cleared`).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'vehicle_clearances.csv';
    a.click();
  });

  document.getElementById('clear').addEventListener('click', ()=>{ q.value=''; applyFilter(); });
  q.addEventListener('input', ()=>{
    if(window.__t) clearTimeout(window.__t);
    window.__t = setTimeout(applyFilter, 120);
  });

  // Voice search
  let recognition = null;
  function startVoice(){
    if(!SR){ q.focus(); return; }
    if(!isHttps){ alert('Voice search requires HTTPS.'); return; }
    recognition = recognition || new SR();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.onstart = ()=>{ micBtn.classList.add('listening'); };
    recognition.onend = ()=>{ micBtn.classList.remove('listening'); };
    recognition.onerror = ()=>{ micBtn.classList.remove('listening'); };
    recognition.onresult = (e)=>{
      const transcript = e.results[0][0].transcript || '';
      const map = [[' zero ',' 0 '],[' oh ',' 0 '],[' o ',' 0 '],[' one ',' 1 '],[' won ',' 1 '],[' two ',' 2 '],[' to ',' 2 '],[' too ',' 2 '],[' three ',' 3 '],[' tree ',' 3 '],[' four ',' 4 '],[' for ',' 4 '],[' fore ',' 4 '],[' five ',' 5 '],[' fife ',' 5 '],[' six ',' 6 '],[' sex ',' 6 '],[' seven ',' 7 '],[' sven ',' 7 '],[' eight ',' 8 '],[' ate ',' 8 '],[' nine ',' 9 '],[' dash ','-']];
      let s = (' ' + transcript.toLowerCase() + ' ').replace(/\s+/g,' ');
      map.forEach(([w,d]) => s = s.replaceAll(w,d));
      q.value = s.toUpperCase().trim();
      applyFilter();
    };
    try{ recognition.start(); }catch(e){ /* ignore */ }
  }
  micBtn.addEventListener('click', ()=>{
    if(!SR){
      // Fallback for iOS Safari: focus the input so the keyboard mic can be used.
      q.focus();
      setTimeout(()=>{
        alert('Tip: tap the keyboard microphone to dictate, then release to search.');
      }, 50);
      return;
    }
    startVoice();
  });
</script>
</body>
</html>
