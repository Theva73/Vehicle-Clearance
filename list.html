<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Green List - Gemini API Integration</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f172a;
    --panel: #1e293b;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --outline: #334155;
    --accent: #22c55e;
    --accent-dark: #16a34a;
    --red: #ef4444;
    --yellow: #f59e0b;
    --purple: #8b5cf6;
    --purple-dark: #6d28d9;
  }
  * { box-sizing: border-box; }
  html, body {
    height: 100%;
    overflow: hidden;
  }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', system-ui, sans-serif;
  }
  .wrap {
    max-width: 780px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  .sticky-header {
    flex-shrink: 0;
    padding: 20px 14px 16px 14px;
    background-color: var(--bg);
  }
  .scroll-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0 14px 80px 14px;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
   .header-left {
      flex-grow: 1;
  }
  h1 {
    font-size: clamp(20px, 4vw, 28px);
    margin: 0;
    font-weight: 800;
  }
  .subtitle {
    color: var(--muted);
    font-size: 14px;
    margin-top: 4px;
  }
  .card {
    background: var(--panel);
    border: 1px solid var(--outline);
    border-radius: 16px;
    padding: 16px;
  }
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  .input {
    flex: 1;
    display: flex;
    align-items: center;
    background: #0f172a;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 12px 14px;
  }
  .input input {
    flex: 1;
    border: 0;
    background: transparent;
    outline: none;
    color: var(--text);
    font-size: 16px;
  }
  .btn {
    border: 0;
    border-radius: 12px;
    padding: 12px 16px;
    background: #334155;
    color: var(--text);
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s;
    white-space: nowrap;
  }
  .btn:hover {
    background: #475569;
  }
  .btn.mic {
    background: var(--purple-dark);
  }
  .btn.mic:hover {
    background: #5b21b6;
  }
  .btn.mic.listening {
    background: var(--red);
    animation: pulse-ring 1.5s infinite;
  }
  .btn.danger {
      background-color: #991b1b;
  }
  .btn.danger:hover {
      background-color: #b91c1c;
  }
  .list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .hint {
    color: var(--muted);
    font-size: 12px;
    text-align: center;
  }
  .notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    z-index: 1001;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
  }
  .notification.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-20px);
  }
  .notification.success { background-color: var(--accent-dark); }
  .notification.error { background-color: var(--red); }
  .notification.info { background-color: var(--yellow); }

  .list-item {
    background: var(--panel);
    border: 1px solid var(--outline);
    border-radius: 12px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background-color 0.2s;
  }
  .list-item-plate {
    font-family: monospace;
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--text);
  }
  .list-item-badge {
    padding: 5px 10px;
    border-radius: 9999px;
    background: #14532d;
    color: #bbf7d0;
    font-weight: 600;
    font-size: 12px;
  }

  .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
  }
  
  /* RESTORED: Original Search Result Styles */
  .car-plate-display {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
      border: 4px solid #fbbf24;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), inset 0 2px 4px rgba(255, 255, 255, 0.1), 0 0 20px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
  }
  .car-plate-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shine 3s infinite;
  }
  .car-plate-text {
      font-family: 'Courier New', monospace;
      font-weight: 900;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      letter-spacing: 4px;
      color: white !important;
      font-size: 2.5rem;
      flex-grow: 1;
      text-align: center;
  }
  .plate-status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 700;
    background-color: var(--accent-dark);
    color: white;
    flex-shrink: 0;
  }
  .search-highlight {
      color: white !important;
      background: none !important;
      animation: glow 2s ease-in-out infinite alternate;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
  }
  @keyframes shine {
      0% { left: -100%; }
      100% { left: 100%; }
  }
  @keyframes glow {
      from { filter: drop-shadow(0 0 5px #fbbf24); }
      to { filter: drop-shadow(0 0 15px #f59e0b); }
  }

  /* Settings Modal Styles */
  .settings-btn {
    background: none;
    border: 1px solid var(--outline);
    cursor: pointer;
    padding: 8px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    margin-left: 16px;
  }
  .settings-btn:hover {
    background-color: var(--panel);
  }
  .settings-btn svg {
    width: 24px;
    height: 24px;
    color: var(--muted);
  }
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    animation: fadeInModal 0.2s ease-out forwards;
  }
  .modal-overlay.visible {
    display: flex;
  }
  .modal-panel {
    background-color: var(--bg);
    border: 1px solid var(--outline);
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .modal-header h2 {
    margin: 0;
    font-size: 20px;
  }
  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--muted);
    cursor: pointer;
  }
  .modal-content .api-key-input, .modal-content .prompt-area {
    background: var(--panel);
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 12px 14px;
  }
  .modal-content .api-key-input input, .modal-content .prompt-area textarea {
    flex: 1;
    border: 0;
    background: transparent;
    outline: none;
    color: var(--text);
    font-size: 16px;
    font-family: 'Inter', system-ui, sans-serif;
  }
  .modal-content .prompt-area {
    margin-top: 12px;
  }
  .modal-content .prompt-area textarea {
    height: 200px;
    resize: vertical;
    font-size: 14px;
  }
  @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
  }
  @keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
  }

</style>
</head>
<body>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal-panel">
      <div class="modal-header">
        <h2>API Settings</h2>
        <button id="closeSettingsBtn" class="close-btn">&times;</button>
      </div>
      <div class="modal-content">
        <label for="apiKeyInput" class="subtitle">Gemini API Key</label>
        <div class="api-key-input" style="margin-top: 8px;">
            <input type="password" id="apiKeyInput" placeholder="Paste your Gemini API Key here">
        </div>
        <label for="geminiPrompt" class="subtitle" style="display: block; margin-top: 16px;">Gemini Prompt</label>
        <div class="prompt-area">
          <textarea id="geminiPrompt" placeholder="Enter your prompt for the Gemini API here..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="sticky-header">
      <header>
        <div class="header-left">
          <h1>Green List</h1>
          <div class="subtitle">Local search with Voice, CSV, and Gemini API Image Import.</div>
        </div>
        <button id="backBtn" class="btn">Back to Main</button>
        <button id="settingsBtn" class="settings-btn" title="API Settings">
         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
  <path d="M19.43,12.98c0.04-0.32,0.07-0.64,0.07-0.98s-0.03-0.66-0.07-0.98l2.11-1.65c0.19-0.15,0.24-0.42,0.12-0.64l-2-3.46 c-0.12-0.22-0.39-0.3-0.61-0.22l-2.49,1c-0.52-0.4-1.08-0.73-1.69-0.98l-0.38-2.65C14.46,2.18,14.25,2,14,2h-4 c-0.25,0-0.46,0.18-0.49,0.42L9.13,5.07c-0.61,0.25-1.17,0.59-1.69,0.98l-2.49-1c-0.23-0.09-0.49,0-0.61,0.22l-2,3.46 c-0.13,0.22-0.07,0.49,0.12,0.64l2.11,1.65C4.57,11.34,4.54,11.66,4.54,12s0.03,0.66,0.07,0.98l-2.11,1.65 c-0.19,0.15-0.24,0.42-0.12,0.64l2,3.46c0.12,0.22,0.39,0.3,0.61,0.22l2.49-1c0.52,0.4,1.08,0.73,1.69,0.98l0.38,2.65 C9.54,21.82,9.75,22,10,22h4c0.25,0,0.46-0.18,0.49-0.42l0.38-2.65c0.61-0.25,1.17-0.59,1.69-0.98l2.49,1 c0.23,0.09,0.49,0,0.61-0.22l2-3.46c0.12-0.22,0.07-0.49-0.12-0.64L19.43,12.98z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3 s3,1.34,3,3S13.66,15,12,15z"/>
</svg>
        </button>
      </header>

      <div class="card">
        <div class="row">
          <label class="btn" style="background-color: var(--purple-dark);">
            <input id="geminiImageFile" type="file" accept="image/*" style="display:none">
            Import with API
          </label>
          <label class="btn" style="background-color: var(--accent-dark);">
            <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none">
            Import CSV
          </label>
          <button class="btn" id="exportBtn">Export CSV</button>
          <button class="btn" id="saveBtn">Save List</button>
          <button class="btn danger" id="clearListBtn">Clear List</button>
        </div>
        <div class="row" style="margin-top:12px">
          <div class="input"><input id="searchBox" placeholder="Search Vehicle..." inputmode="numeric" autocomplete="off"></div>
          <button class="btn mic" id="micBtn" title="Voice search">🎤 Voice</button>
          <button class="btn" id="clearSearchBtn">Clear Search</button>
        </div>
        <div class="row" style="margin-top: 12px;">
          <span id="count" class="subtitle" style="flex:1; text-align:left;">0 rows</span>
        </div>
      </div>
    </div>
    
    <div class="scroll-content">
      <div id="list" class="list"></div>
      <div id="empty" class="hint" style="padding: 40px 0;">
          No rows yet. Import a file or load a saved list.<br>
          CSV headers accepted: <b>vehicleNumber</b> OR <b>Code, Number, Suffix</b>. Location is optional.
      </div>
    </div>
  </div>

<script>
  // --- Voice Search Implementation ---
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const playBeep = (frequency = 440, duration = 100, type = 'sine') => {
      if (!audioContext) return;
      try {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          oscillator.type = type;
          oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration / 1000);
          oscillator.start();
          oscillator.stop(audioContext.currentTime + duration / 1000);
      } catch (error) {
          console.error("Beep playback failed:", error);
      }
  };

  let recognition = null;
  let isVoiceSearchActive = false;
  let voiceSearchTimeout = null;
  const searchBox = document.getElementById('searchBox');
  const micBtn = document.getElementById('micBtn');

  const initializeVoiceRecognition = () => {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          console.warn('Speech recognition not supported');
          return false;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onstart = () => {
          isVoiceSearchActive = true;
          if (micBtn) micBtn.classList.add('listening');
      };
      recognition.onresult = (event) => handleVoiceResult(event);
      recognition.onerror = (event) => {
          let errorMessage = 'An error occurred during voice recognition.';
          if (event.error === 'no-speech') errorMessage = 'No speech detected. Please try again.';
          else if (event.error === 'not-allowed') errorMessage = 'Microphone permission denied.';
          showNotification(errorMessage, 'error');
          stopVoiceSearch();
      };
      recognition.onend = () => {
          if (isVoiceSearchActive) stopVoiceSearch();
      };
      return true;
  };

  const processVehicleNumber = (spokenText) => {
      let processed = spokenText.toLowerCase().trim();
      const fillerWords = ['um', 'uh', 'the', 'number', 'is', 'vehicle', 'car', 'plate'];
      fillerWords.forEach(word => {
          processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), ' ');
      });
      const numberMappings = [
          ['zero', '0'], ['oh', '0'], ['o', '0'], ['one', '1'], ['won', '1'], 
          ['two', '2'], ['to', '2'], ['too', '2'], ['three', '3'], ['tree', '3'],
          ['four', '4'], ['for', '4'], ['fore', '4'], ['five', '5'], ['fife', '5'],
          ['six', '6'], ['sex', '6'], ['seven', '7'], ['sven', '7'],
          ['eight', '8'], ['ate', '8'], ['nine', '9'], ['nein', '9']
      ];
      numberMappings.forEach(([word, digit]) => {
          processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), ` ${digit} `);
      });
      const digitMatches = processed.match(/\d+/g);
      return digitMatches ? digitMatches.join('') : '';
  };

  const isValidVehicleNumber = (vehicleNumber) => {
      if (!vehicleNumber) return false;
      if (vehicleNumber.length < 3 || vehicleNumber.length > 8) return false;
      return /^\d+$/.test(vehicleNumber);
  };

  const handleVoiceResult = (event) => {
      let transcript = event.results[0][0].transcript;
      let detectedNumber = processVehicleNumber(transcript);
      if (isValidVehicleNumber(detectedNumber)) {
          completeVoiceSearch(detectedNumber);
      } else {
          showNotification(`Could not detect a valid number from "${transcript}"`, 'error');
          stopVoiceSearch();
      }
  };

  const startVoiceSearch = () => {
      if (!recognition) {
          if (!initializeVoiceRecognition()) {
              showNotification("Voice search not supported on this device", "error");
              return;
          }
      }
      if (isVoiceSearchActive) {
          stopVoiceSearch();
          return;
      }
      try {
          playBeep(523, 150);
          recognition.start();
          voiceSearchTimeout = setTimeout(() => {
              showNotification("Voice search timed out.", "error");
              stopVoiceSearch();
          }, 8000);
      } catch (error) {
          showNotification("Failed to start voice search", "error");
      }
  };

  const stopVoiceSearch = () => {
      if (!isVoiceSearchActive) return;
      playBeep(392, 150);
      if (recognition) recognition.stop();
      if (voiceSearchTimeout) clearTimeout(voiceSearchTimeout);
      if (micBtn) micBtn.classList.remove('listening');
      isVoiceSearchActive = false;
      voiceSearchTimeout = null;
  };

  const completeVoiceSearch = (detectedNumber) => {
      if (searchBox && detectedNumber) {
          searchBox.value = detectedNumber;
          searchBox.dispatchEvent(new Event('input', { bubbles: true }));
      }
      stopVoiceSearch();
  };

  // --- CSV, Gemini API, Local Storage, and List Management ---
  const LOCAL_STORAGE_KEY = 'greenListData';
  const API_KEY_STORAGE_KEY = 'geminiApiKey';
  let allRows = [];
  let filtered = [];
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const countEl = document.getElementById('count');
  const settingsModal = document.getElementById('settingsModal');
  const settingsBtn = document.getElementById('settingsBtn');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');
  const geminiPromptEl = document.getElementById('geminiPrompt');
  const apiKeyInput = document.getElementById('apiKeyInput');

  function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
          notification.classList.add('show');
      }, 10);
      setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
              notification.remove();
          }, 300);
      }, 4000);
  }

  function saveListToLocal() {
      try {
          localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allRows));
          showNotification('List saved to local storage.', 'success');
      } catch (e) {
          console.error("Failed to save to local storage", e);
          showNotification('Could not save list. Storage may be full.', 'error');
      }
  }

  function loadListFromLocal() {
      const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (savedData) {
          try {
              allRows = JSON.parse(savedData);
              showNotification('Loaded list from local storage.', 'info');
          } catch (e) {
              console.error("Failed to parse saved data", e);
              allRows = [];
              localStorage.removeItem(LOCAL_STORAGE_KEY);
          }
      }
      applyFilter();
  }

  function normalizePlate(s){
    return (s||'').toString().toUpperCase().replace(/\s+/g,'').replace(/O/g,'0').replace(/[^A-Z0-9]/g,'');
  }

  function joinFromColumns(row){
    let plate = row.vehicleNumber || row.VehicleNumber || row.plate || row.Plate;
    if(plate) return normalizePlate(plate);
    const code = row.Code || row.code;
    const num = row.Number || row.number;
    const suffix = row.Suffix || row.suffix;
    if(code && num) return normalizePlate(`${code}${num}${suffix || ''}`);
    return '';
  }
  
  function parseCsvText(text) {
      const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
      if (lines.length < 2) return [];
      
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const locationHeader = headers.find(h => h.toLowerCase() === 'location');
      const vehicleNumberHeader = headers.find(h => h.toLowerCase().replace(/\s/g,'') === 'vehiclenumber');


      const newRows = [];
      for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
          const row = Object.fromEntries(headers.map((h, idx) => [h, cols[idx] || '']));
          const plate = vehicleNumberHeader ? row[vehicleNumberHeader] : joinFromColumns(row);
          const location = locationHeader ? row[locationHeader] : 'N/A';
          if (plate) newRows.push({ vehicleNumber: normalizePlate(plate), location: location });
      }
      return newRows;
  }

  // RESTORED: Original render function with detailed search result
  function render(){
    const searchTerm = searchBox.value.trim().toUpperCase();
    listEl.innerHTML = '';

    if (allRows.length === 0) {
        emptyEl.style.display = 'block';
        listEl.style.display = 'block';
        countEl.textContent = '0 rows';
        emptyEl.innerHTML = 'No rows yet. Import a file or load a saved list.<br>CSV headers accepted: <b>vehicleNumber</b> OR <b>Code, Number, Suffix</b>.';
        return;
    }

    if (searchTerm && filtered.length === 0) {
        listEl.style.display = 'block';
        emptyEl.style.display = 'none';
        countEl.textContent = `0 matches found for "${searchTerm}"`;
        listEl.innerHTML = `
            <div class="space-y-4 animate-fade-in">
                <div class="text-center py-8 bg-panel rounded-2xl border border-outline">
                    <h3 class="text-xl font-semibold">Not Found on Green List</h3>
                    <p class="mt-2 text-muted">Vehicle <strong>${searchTerm}</strong> is not on the current list.</p>
                </div>
            </div>`;
        return;
    }

    emptyEl.style.display = 'none';
    listEl.style.display = 'flex';
    countEl.textContent = `Showing ${filtered.length} of ${allRows.length} rows`;

    if (searchTerm && filtered.length === 1) {
        const c = filtered[0];
        const plateHTML = `
            <div class="car-plate-display mb-4 animate-fade-in">
                <div class="car-plate-text">
                    <span class="search-highlight">${c.vehicleNumber}</span>
                </div>
                <div class="plate-status-badge">
                    ✓ CLEARED
                </div>
            </div>
            <div class="card animate-fade-in" style="padding: 24px;">
                <div style="text-align: center;">
                    <p style="font-size: 0.875rem; color: var(--muted); text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Location</p>
                    <p style="font-weight: 700; color: var(--text); font-size: 1.5rem;">${c.location || 'N/A'}</p>
                </div>
            </div>
        `;
        listEl.innerHTML = plateHTML;
    } else {
        const listHTML = filtered.map(c => `
            <div class="list-item animate-fade-in">
                <span class="list-item-plate">${c.vehicleNumber}</span>
                <span class="list-item-badge">Cleared</span>
            </div>
        `).join('');
        listEl.innerHTML = listHTML;
    }
  }

  function applyFilter(){
    const term = normalizePlate(searchBox.value);
    if (!term) {
        filtered = [...allRows];
    } else {
        filtered = allRows.filter(r => r.vehicleNumber.includes(term));
    }
    render();
  }
  
  // --- Gemini API Implementation ---
  const fileToGenerativePart = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64Data = reader.result.split(',')[1];
        resolve({
          inlineData: {
            mimeType: file.type,
            data: base64Data
          }
        });
      };
      reader.onerror = (err) => reject(err);
      reader.readAsDataURL(file);
    });
  };

  document.getElementById('geminiImageFile').addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const apiKey = apiKeyInput.value.trim();
    if (!apiKey) {
        showNotification('Please set your Gemini API Key in the settings panel (⚙️) first.', 'error');
        e.target.value = '';
        return;
    }

    const prompt = geminiPromptEl.value;
    if (!prompt) {
        showNotification('Please enter a prompt in the settings panel (⚙️).', 'error');
        e.target.value = '';
        return;
    }

    showNotification('Processing with Gemini API...', 'info');

    try {
        const imagePart = await fileToGenerativePart(file);
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{
                parts: [
                    { text: prompt },
                    imagePart
                ]
            }]
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
        }

        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!text) {
            throw new Error('No text returned from API.');
        }
        
        const cleanedText = text.replace(/```csv\n|```/g, '').trim();
        const newRows = parseCsvText(cleanedText);

        if (newRows.length === 0) {
            showNotification('Gemini could not extract valid data. Check the prompt and image.', 'error');
            return;
        }

        allRows = newRows;
        searchBox.value = '';
        applyFilter();
        saveListToLocal();
        showNotification(`Successfully imported ${newRows.length} vehicles via Gemini.`, 'success');

    } catch (error) {
        console.error('Gemini API Error:', error);
        showNotification(error.message, 'error');
    } finally {
        e.target.value = '';
    }
  });

  // --- Existing CSV and Event Listener Code ---
  document.getElementById('csvFile').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const text = await file.text();
    const newRows = parseCsvText(text);

    if (newRows.length === 0) {
        showNotification('Could not find valid vehicle numbers in the CSV.', 'error');
        return;
    }

    allRows = newRows;
    searchBox.value = '';
    applyFilter();
    saveListToLocal();
    e.target.value = '';
  });

  document.getElementById('exportBtn').addEventListener('click', ()=>{
    if(!allRows.length){ showNotification('Nothing to export.', 'error'); return; }
    const csv = 'vehicleNumber,location,status\n' + allRows.map(r => `"${r.vehicleNumber}","${r.location || 'N/A'}","Cleared"`).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'green_list_export.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  });
  
  document.getElementById('backBtn').addEventListener('click', () => {
    window.location.href = 'index.html';
  });

  document.getElementById('saveBtn').addEventListener('click', saveListToLocal);

  document.getElementById('clearListBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to permanently delete the current list?')) {
          allRows = [];
          filtered = [];
          localStorage.removeItem(LOCAL_STORAGE_KEY);
          applyFilter();
          showNotification('List has been cleared.', 'success');
      }
  });

  searchBox.addEventListener('input', ()=>{ 
    if(window.__t) clearTimeout(window.__t); 
    window.__t = setTimeout(applyFilter, 120); 
  });

  document.getElementById('clearSearchBtn').addEventListener('click', ()=>{ 
    searchBox.value=''; 
    applyFilter(); 
  });

  micBtn.addEventListener('click', startVoiceSearch);

  // --- Settings Modal Logic ---
  settingsBtn.addEventListener('click', () => {
    settingsModal.classList.add('visible');
  });

  closeSettingsBtn.addEventListener('click', () => {
    settingsModal.classList.remove('visible');
    const apiKey = apiKeyInput.value.trim();
    if (apiKey) {
      localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
      showNotification('API Key saved.', 'info');
    }
  });

  settingsModal.addEventListener('click', (e) => {
    if (e.target === settingsModal) {
      closeSettingsBtn.click();
    }
  });


  // --- Initial setup ---
  window.addEventListener('load', () => {
      initializeVoiceRecognition();
      loadListFromLocal();

      const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
      if (savedApiKey) {
        apiKeyInput.value = savedApiKey;
      }

      geminiPromptEl.value = `Analyze the attached image, which contains a table. Your task is to meticulously extract all the information from this table and format it as a CSV (Comma-Separated Values) text.
The first column often contains "DOC" or "OC", which should be ignored.
The primary columns to extract are for the vehicle number and the location.
Combine the separate parts of the vehicle number (e.g., "GBD", "3945", "J") into a single, normalized string like "GBD3945J".
The final columns of the table are the date and the location (e.g., "COURTYARD", "BASEMENT").
Your output should be a CSV with two headers: vehicleNumber,location

Example Input Row: DOC | GBD | 3945 | J | 13TH AUG 2025 | COURTYARD
Example Output Row: GBD3945J,COURTYARD

Please generate the full CSV data from the image now.`;
  });
</script>
</body>
</html>
