<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Green List - Voice Search</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f172a;
    --panel: #1e293b;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --outline: #334155;
    --accent: #22c55e;
    --accent-dark: #16a34a;
    --red: #ef4444;
    --yellow: #f59e0b;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', system-ui, sans-serif;
  }
  .wrap {
    max-width: 780px;
    margin: 0 auto;
    padding: 20px 14px 80px;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  h1 {
    font-size: clamp(20px, 4vw, 28px);
    margin: 0;
    font-weight: 800;
  }
  .subtitle {
    color: var(--muted);
    font-size: 14px;
    margin-top: 4px;
  }
  .card {
    background: var(--panel);
    border: 1px solid var(--outline);
    border-radius: 16px;
    padding: 16px;
  }
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }
  .input {
    flex: 1;
    display: flex;
    align-items: center;
    background: #0f172a;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 12px 14px;
  }
  .input input {
    flex: 1;
    border: 0;
    background: transparent;
    outline: none;
    color: var(--text);
    font-size: 16px;
  }
  .btn {
    border: 0;
    border-radius: 12px;
    padding: 12px 16px;
    background: #334155;
    color: var(--text);
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s;
  }
  .btn:hover {
    background: #475569;
  }
  .btn.mic {
    background: #6d28d9;
  }
  .btn.mic:hover {
    background: #5b21b6;
  }
  .btn.mic.listening {
    background: var(--red);
    animation: pulse-ring 1.5s infinite;
  }
  .btn.danger {
      background-color: #991b1b;
  }
  .btn.danger:hover {
      background-color: #b91c1c;
  }
  .list {
    margin-top: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .item {
    background: #0f172a;
    border: 1px solid var(--outline);
    border-radius: 12px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .item-details {
      flex-grow: 1;
  }
  .plate {
    letter-spacing: 0.08em;
    font-weight: 800;
    font-size: 1.1rem;
    color: #93c5fd;
  }
  .location {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 2px;
  }
  .badge {
    padding: 6px 12px;
    border-radius: 999px;
    background: #14532d;
    border: 1px solid #166534;
    color: #bbf7d0;
    font-weight: 700;
    font-size: 12px;
    flex-shrink: 0;
  }
  .hint {
    color: var(--muted);
    font-size: 12px;
    margin-top: 12px;
    text-align: center;
  }
  .back-btn {
    background: none;
    border: 1px solid var(--outline);
  }
  .notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
  }
  .notification.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-20px);
  }
  .notification.success { background-color: var(--accent-dark); }
  .notification.error { background-color: var(--red); }
  .notification.info { background-color: var(--yellow); }

  @keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Green List</h1>
        <div class="subtitle">Local CSV search with advanced voice recognition.</div>
      </div>
      <button class="btn back-btn" id="backBtn">Back to Main</button>
    </header>

    <div class="card">
      <div class="row">
        <label class="btn" style="background-color: var(--accent-dark);">
          <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none">
          Import CSV
        </label>
        <button class="btn" id="exportBtn">Export CSV</button>
        <button class="btn" id="saveBtn">Save List</button>
        <button class="btn danger" id="clearListBtn">Clear List</button>
      </div>
       <div class="row" style="margin-top:12px">
        <div class="input"><input id="searchBox" placeholder="Search Vehicle..." inputmode="numeric" autocomplete="off"></div>
        <button class="btn mic" id="micBtn" title="Voice search">ðŸŽ¤ Voice</button>
        <button class="btn" id="clearSearchBtn">Clear Search</button>
      </div>
      <div class="row" style="margin-top: 12px;">
         <span id="count" class="subtitle" style="flex:1; text-align:left;">0 rows</span>
      </div>
    </div>

    <div id="list" class="list"></div>
    <div id="empty" class="hint" style="padding: 40px 0;">
        No rows yet. Import a CSV or load a saved list.<br>
        CSV headers accepted: <b>vehicleNumber</b> OR <b>Code, Number, Suffix</b>. Location is optional.
    </div>
  </div>

<script>
  // --- Voice Search Implementation (Upgraded) ---
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const playBeep = (frequency = 440, duration = 100, type = 'sine') => {
      if (!audioContext) return;
      try {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          oscillator.type = type;
          oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration / 1000);
          oscillator.start();
          oscillator.stop(audioContext.currentTime + duration / 1000);
      } catch (error) {
          console.error("Beep playback failed:", error);
      }
  };

  let recognition = null;
  let isVoiceSearchActive = false;
  let voiceSearchTimeout = null;
  const searchBox = document.getElementById('searchBox');
  const micBtn = document.getElementById('micBtn');

  const initializeVoiceRecognition = () => {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          console.warn('Speech recognition not supported');
          return false;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.maxAlternatives = 3;
      recognition.onstart = () => {
          isVoiceSearchActive = true;
          if (micBtn) micBtn.classList.add('listening');
      };

      recognition.onresult = (event) => {
          handleVoiceResult(event);
      };

      recognition.onerror = (event) => {
          let errorMessage = 'An error occurred during voice recognition.';
          if (event.error === 'no-speech') errorMessage = 'No speech detected. Please try again.';
          else if (event.error === 'not-allowed') errorMessage = 'Microphone permission denied.';
          showNotification(errorMessage, 'error');
          stopVoiceSearch();
      };
      recognition.onend = () => {
          if (isVoiceSearchActive) stopVoiceSearch();
      };
      return true;
  };

  const processVehicleNumber = (spokenText) => {
      let processed = spokenText.toLowerCase().trim();
      const fillerWords = ['um', 'uh', 'the', 'number', 'is', 'vehicle', 'car', 'plate'];
      fillerWords.forEach(word => {
          processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), ' ');
      });
      const numberMappings = [
          ['zero', '0'], ['oh', '0'], ['o', '0'], ['one', '1'], ['won', '1'], 
          ['two', '2'], ['to', '2'], ['too', '2'], ['three', '3'], ['tree', '3'],
          ['four', '4'], ['for', '4'], ['fore', '4'], ['five', '5'], ['fife', '5'],
          ['six', '6'], ['sex', '6'], ['seven', '7'], ['sven', '7'],
          ['eight', '8'], ['ate', '8'], ['nine', '9'], ['nein', '9']
      ];
      numberMappings.forEach(([word, digit]) => {
          processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), ` ${digit} `);
      });
      const digitMatches = processed.match(/\d+/g);
      return digitMatches ? digitMatches.join('') : '';
  };

  const isValidVehicleNumber = (vehicleNumber) => {
      if (!vehicleNumber) return false;
      if (vehicleNumber.length < 3 || vehicleNumber.length > 8) return false;
      return /^\d+$/.test(vehicleNumber);
  };

  const handleVoiceResult = (event) => {
      let transcript = event.results[0][0].transcript;
      let detectedNumber = processVehicleNumber(transcript);
      
      if (!isValidVehicleNumber(detectedNumber) && event.results[0].length > 1) {
          for (let i = 1; i < event.results[0].length; i++) {
              const altTranscript = event.results[0][i].transcript;
              const altNumber = processVehicleNumber(altTranscript);
              if (isValidVehicleNumber(altNumber)) {
                  detectedNumber = altNumber;
                  break;
              }
          }
      }
      
      if (isValidVehicleNumber(detectedNumber)) {
          completeVoiceSearch(detectedNumber);
      } else {
          showNotification(`Could not detect a valid number from "${transcript}"`, 'error');
          stopVoiceSearch();
      }
  };

  const startVoiceSearch = () => {
      if (!recognition) {
          if (!initializeVoiceRecognition()) {
              showNotification("Voice search not supported on this device", "error");
              return;
          }
      }

      if (isVoiceSearchActive) {
          stopVoiceSearch();
          return;
      }

      try {
          playBeep(523, 150);
          recognition.start();
          voiceSearchTimeout = setTimeout(() => {
              showNotification("Voice search timed out.", "error");
              stopVoiceSearch();
          }, 8000);
      } catch (error) {
          showNotification("Failed to start voice search", "error");
      }
  };

  const stopVoiceSearch = () => {
      if (!isVoiceSearchActive) return;
      playBeep(392, 150);
      if (recognition) recognition.stop();
      if (voiceSearchTimeout) clearTimeout(voiceSearchTimeout);
      if (micBtn) micBtn.classList.remove('listening');
      isVoiceSearchActive = false;
      voiceSearchTimeout = null;
  };

  const completeVoiceSearch = (detectedNumber) => {
      if (searchBox && detectedNumber) {
          searchBox.value = detectedNumber;
          searchBox.dispatchEvent(new Event('input', { bubbles: true }));
      }
      stopVoiceSearch();
  };

  // --- CSV, Local Storage, and List Management ---
  const LOCAL_STORAGE_KEY = 'greenListData';
  let allRows = [];
  let filtered = [];
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const countEl = document.getElementById('count');

  function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
          notification.classList.add('show');
      }, 10);

      setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
              notification.remove();
          }, 300);
      }, 3000);
  }

  function saveListToLocal() {
      try {
          localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allRows));
          showNotification('List saved to local storage.', 'success');
      } catch (e) {
          console.error("Failed to save to local storage", e);
          showNotification('Could not save list. Storage may be full.', 'error');
      }
  }

  function loadListFromLocal() {
      const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (savedData) {
          try {
              allRows = JSON.parse(savedData);
              showNotification('Loaded list from local storage.', 'info');
          } catch (e) {
              console.error("Failed to parse saved data", e);
              allRows = [];
              localStorage.removeItem(LOCAL_STORAGE_KEY);
          }
      }
      applyFilter();
  }

  function normalizePlate(s){
    return (s||'').toString().toUpperCase().replace(/\s+/g,'').replace(/O/g,'0').replace(/[^A-Z0-9]/g,'');
  }

  // --- REVERTED to original CSV parsing logic ---
  function joinFromColumns(row){
    let plate = row.vehicleNumber || row.VehicleNumber || row.plate || row.Plate;
    if(plate) return normalizePlate(plate);
    const code = row.Code || row.code;
    const num = row.Number || row.number;
    const suffix = row.Suffix || row.suffix;
    if(code && num) return normalizePlate(`${code}${num}${suffix || ''}`); // Suffix is optional
    return '';
  }

  function render(){
    listEl.innerHTML = '';
    if (allRows.length === 0) {
        emptyEl.style.display = 'block';
        listEl.style.display = 'none';
        countEl.textContent = '0 rows';
        emptyEl.innerHTML = 'No rows yet. Import a CSV or load a saved list.<br>CSV headers accepted: <b>vehicleNumber</b> OR <b>Code, Number, Suffix</b>.';
        return;
    }

    if(filtered.length === 0){
      emptyEl.style.display = 'block';
      listEl.style.display = 'none';
      countEl.textContent = `${allRows.length} total rows`;
      emptyEl.innerHTML = `No results for "<b>${searchBox.value}</b>"`;
    } else {
      emptyEl.style.display = 'none';
      listEl.style.display = 'flex';
      countEl.textContent = `Showing ${filtered.length} of ${allRows.length} rows`;
    }

    const frag = document.createDocumentFragment();
    filtered.forEach(r => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="item-details">
            <div class="plate">${r.vehicleNumber}</div>
            <div class="location">${r.location || 'N/A'}</div>
        </div>
        <span class="badge">Cleared</span>`;
      frag.appendChild(div);
    });
    listEl.appendChild(frag);
  }

  function applyFilter(){
    const term = normalizePlate(searchBox.value);
    if (!term) {
        filtered = [...allRows];
    } else {
        filtered = allRows.filter(r => r.vehicleNumber.includes(term));
    }
    render();
  }

  document.getElementById('csvFile').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(!lines.length){ showNotification('Empty CSV', 'error'); return; }
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    
    const locationHeader = headers.find(h => h.toLowerCase() === 'location');

    const newRows = [];
    for(let i=1; i<lines.length; i++){
      const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
      const row = Object.fromEntries(headers.map((h,idx)=>[h, cols[idx] || '']));
      const plate = joinFromColumns(row); // Use the flexible join function
      const location = locationHeader ? row[locationHeader] : 'N/A';
      if(plate) newRows.push({vehicleNumber: plate, location: location});
    }

    if (newRows.length === 0) {
        showNotification('Could not find valid vehicle numbers in the CSV.', 'error');
        return;
    }

    allRows = newRows;
    searchBox.value = '';
    applyFilter();
    saveListToLocal();
    e.target.value = ''; // Reset file input
  });

  document.getElementById('exportBtn').addEventListener('click', ()=>{
    if(!allRows.length){ showNotification('Nothing to export.', 'error'); return; }
    const csv = 'vehicleNumber,location,status\n' + allRows.map(r => `"${r.vehicleNumber}","${r.location || 'N/A'}","Cleared"`).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'green_list_export.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  });
  
  document.getElementById('backBtn').addEventListener('click', () => {
    window.location.href = 'index.html';
  });

  document.getElementById('saveBtn').addEventListener('click', saveListToLocal);

  document.getElementById('clearListBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to permanently delete the current list?')) {
          allRows = [];
          filtered = [];
          localStorage.removeItem(LOCAL_STORAGE_KEY);
          applyFilter();
          showNotification('List has been cleared.', 'success');
      }
  });

  searchBox.addEventListener('input', ()=>{ 
    if(window.__t) clearTimeout(window.__t); 
    window.__t = setTimeout(applyFilter, 120); 
  });

  document.getElementById('clearSearchBtn').addEventListener('click', ()=>{ 
    searchBox.value=''; 
    applyFilter(); 
  });

  micBtn.addEventListener('click', startVoiceSearch);

  // Initial setup
  window.addEventListener('load', () => {
      initializeVoiceRecognition();
      loadListFromLocal();
  });
</script>
</body>
</html>
