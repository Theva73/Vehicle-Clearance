<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Clearance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-root"></div>

```
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, Timestamp, getDoc, getDocs, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const ADMIN_CODE = "ADMIN2025";
    const config = {
      apiKey: "AIzaSyC51Zo7V75JjOpLOdusf6ZKUzEG_gqFcV4",
      authDomain: "vehicle-clearance.firebaseapp.com",
      projectId: "vehicle-clearance",
      storageBucket: "vehicle-clearance.appspot.com",
      messagingSenderId: "187403368572",
      appId: "1:187403368572:web:1f94845da67ef0c7ccf1f9"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const root = document.getElementById('app-root');
    
    let clearances = [], requests = [];
    let unsubClearances, unsubRequests;

    const fmt = (date) => {
        if (!date) return '';
        const d = date instanceof Date ? date : date.toDate();
        return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getFullYear()).slice(-2)}`;
    };

    const notify = (msg, type = 'success') => {
        const div = document.createElement('div');
        div.className = `fixed bottom-5 right-5 p-4 rounded text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        div.textContent = msg;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    };

    const home = () => {
        root.innerHTML = `
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="w-full max-w-lg bg-white rounded-xl shadow-lg p-8 text-center space-y-6">
                    <div>
                        <div class="text-6xl mb-4">üöó</div>
                        <h1 class="text-3xl font-bold text-gray-800">Vehicle Clearance</h1>
                        <p class="text-gray-500">Select an option to continue</p>
                    </div>
                    <div class="space-y-4">
                        <button onclick="requestForm()" class="w-full p-4 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded-lg">
                            üìù Request Clearance
                        </button>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="adminLogin()" class="p-4 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg">
                                üõ°Ô∏è Admin
                            </button>
                            <button onclick="userLogin()" class="p-4 bg-green-100 hover:bg-green-200 text-green-800 rounded-lg">
                                üë• User
                            </button>
                        </div>
                    </div>
                    <div class="pt-4 border-t">
                        <form onsubmit="trackRequest(event)" class="space-y-2">
                            <label class="text-sm text-gray-600">Track Request</label>
                            <div class="flex gap-2">
                                <input id="trackInput" class="flex-1 px-3 py-2 border rounded" placeholder="Vehicle Number"/>
                                <button type="submit" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Track</button>
                            </div>
                        </form>
                        <div id="trackResult" class="mt-4"></div>
                    </div>
                </div>
            </div>
        `;
    };

    const requestForm = () => {
        root.innerHTML = `
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-8">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-2">üìù</div>
                        <h1 class="text-2xl font-bold">Request Vehicle Clearance</h1>
                    </div>
                    <form onsubmit="submitRequest(event)" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input name="ownerName" placeholder="Name/Company" class="px-3 py-2 border rounded" required />
                            <input name="vehicleNumber" placeholder="Vehicle Number" class="px-3 py-2 border rounded" oninput="this.value=this.value.toUpperCase()" required />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input name="contactNumber" placeholder="Contact Number" class="px-3 py-2 border rounded" required />
                            <input name="email" type="email" placeholder="Email" class="px-3 py-2 border rounded" required />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">Entry Date</label>
                                <input name="entryDate" type="date" class="w-full px-3 py-2 border rounded" required />
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Expiry Date</label>
                                <input name="expiryDate" type="date" class="w-full px-3 py-2 border rounded" required />
                            </div>
                        </div>
                        <input name="location" placeholder="Location/Destination" class="w-full px-3 py-2 border rounded" required />
                        <textarea name="purpose" placeholder="Purpose of visit" rows="3" class="w-full px-3 py-2 border rounded" required></textarea>
                        <div class="flex items-center">
                            <input type="checkbox" name="escortRequired" class="mr-2" />
                            <label>Escort Required</label>
                        </div>
                        <div class="flex justify-between pt-4">
                            <button type="button" onclick="home()" class="px-6 py-2 bg-gray-200 rounded hover:bg-gray-300">‚Üê Back</button>
                            <button type="submit" class="px-6 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    };

    const adminLogin = () => {
        root.innerHTML = `
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-2">üõ°Ô∏è</div>
                        <h1 class="text-2xl font-bold">Admin Access</h1>
                    </div>
                    <form onsubmit="adminAuth(event)" class="space-y-4">
                        <div id="codeField" class="hidden">
                            <input id="adminCode" placeholder="Admin Code: ADMIN2025" class="w-full px-3 py-2 border rounded" />
                        </div>
                        <input id="adminEmail" type="email" placeholder="Email" class="w-full px-3 py-2 border rounded" required />
                        <input id="adminPassword" type="password" placeholder="Password" class="w-full px-3 py-2 border rounded" required />
                        <button type="submit" id="adminBtn" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Login</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-4">
                        <span id="toggleText">Need account?</span>
                        <button onclick="toggleAdminMode()" id="toggleBtn" class="text-blue-600 ml-1">Sign Up</button>
                    </p>
                    <button onclick="home()" class="w-full mt-4 py-2 text-gray-600">‚Üê Back</button>
                </div>
            </div>
        `;
    };

    const userLogin = () => {
        root.innerHTML = `
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-2">üë•</div>
                        <h1 class="text-2xl font-bold">User Access</h1>
                    </div>
                    <form onsubmit="userAuth(event)" class="space-y-4">
                        <input id="userEmail" type="email" placeholder="Email" class="w-full px-3 py-2 border rounded" required />
                        <input id="userPassword" type="password" placeholder="Password" class="w-full px-3 py-2 border rounded" required />
                        <button type="submit" id="userBtn" class="w-full py-2 bg-green-600 text-white rounded hover:bg-green-700">Login</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 mt-4">
                        Need account?
                        <button onclick="toggleUserMode()" id="userToggle" class="text-green-600 ml-1">Sign Up</button>
                    </p>
                    <button onclick="home()" class="w-full mt-4 py-2 text-gray-600">‚Üê Back</button>
                </div>
            </div>
        `;
    };

    const adminDash = (user) => {
        root.innerHTML = `
            <header class="bg-white shadow sticky top-0">
                <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üõ°Ô∏è</span>
                        <span class="font-bold">Admin Dashboard</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600">${user.email}</span>
                        <button onclick="signOut(auth)" class="px-4 py-2 bg-red-500 text-white rounded">Logout</button>
                    </div>
                </div>
            </header>
            <main class="container mx-auto p-4 space-y-6">
                <div>
                    <h2 class="text-xl font-bold mb-4">Pending Requests</h2>
                    <div id="requestsList"></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-2xl font-bold">Active Clearances</h1>
                        <button onclick="showModal()" class="px-4 py-2 bg-blue-600 text-white rounded">+ Add</button>
                    </div>
                    <div id="clearancesList"></div>
                </div>
            </main>
            <div id="modal"></div>
        `;
    };

    const userDash = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayClearances = clearances.filter(c => {
            const entry = c.entryDate.toDate();
            const expiry = c.expiryDate.toDate();
            entry.setHours(0, 0, 0, 0);
            expiry.setHours(23, 59, 59, 999);
            return today >= entry && today <= expiry;
        });

        root.innerHTML = `
            <header class="bg-white shadow sticky top-0">
                <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üåû</span>
                        <span class="font-bold">Today's Clearances</span>
                    </div>
                    <button onclick="signOut(auth)" class="px-4 py-2 bg-red-500 text-white rounded">Logout</button>
                </div>
            </header>
            <main class="container mx-auto p-4">
                <div class="space-y-4">
                    ${todayClearances.length === 0 ? 
                        `<div class="text-center py-16 bg-white rounded">
                            <div class="text-4xl mb-4">üöó</div>
                            <h3 class="text-xl font-bold">No Clearances Today</h3>
                        </div>` :
                        todayClearances.map(c => `
                            <div class="bg-white rounded shadow p-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">Owner</p>
                                        <p class="font-bold">${c.ownerName}</p>
                                        <p class="font-mono text-lg text-blue-600">${c.vehicleNumber}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Location</p>
                                        <p>${c.location}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Escort</p>
                                        <p class="${c.escortRequired ? 'text-green-600' : 'text-red-600'}">${c.escortRequired ? 'Required' : 'Not Required'}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </main>
        `;
    };

    // Global functions
    window.home = home;
    window.requestForm = requestForm;
    window.adminLogin = adminLogin;
    window.userLogin = userLogin;

    window.submitRequest = async (e) => {
        e.preventDefault();
        const form = new FormData(e.target);
        await addDoc(collection(db, "clearanceRequests"), {
            ownerName: form.get('ownerName'),
            vehicleNumber: form.get('vehicleNumber').toUpperCase(),
            contactNumber: form.get('contactNumber'),
            email: form.get('email'),
            entryDate: Timestamp.fromDate(new Date(form.get('entryDate'))),
            expiryDate: Timestamp.fromDate(new Date(form.get('expiryDate'))),
            location: form.get('location'),
            purpose: form.get('purpose'),
            escortRequired: form.has('escortRequired'),
            status: 'pending',
            submittedAt: Timestamp.now()
        });
        notify('Request submitted successfully!');
        home();
    };

    window.trackRequest = async (e) => {
        e.preventDefault();
        const vehicleNumber = document.getElementById('trackInput').value.toUpperCase();
        const q = query(collection(db, "clearanceRequests"), where("vehicleNumber", "==", vehicleNumber));
        const snap = await getDocs(q);
        const result = document.getElementById('trackResult');
        
        if (snap.empty) {
            result.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded">No request found</div>`;
        } else {
            const req = snap.docs[0].data();
            result.innerHTML = `
                <div class="p-4 bg-blue-100 text-blue-800 rounded">
                    <p><strong>Status:</strong> ${req.status.toUpperCase()}</p>
                    <p><strong>Owner:</strong> ${req.ownerName}</p>
                    <p><strong>Submitted:</strong> ${fmt(req.submittedAt)}</p>
                </div>
            `;
        }
    };

    window.toggleAdminMode = () => {
        const btn = document.getElementById('adminBtn');
        const toggle = document.getElementById('toggleBtn');
        const text = document.getElementById('toggleText');
        const field = document.getElementById('codeField');
        
        if (btn.textContent === 'Login') {
            btn.textContent = 'Sign Up';
            toggle.textContent = 'Login';
            text.textContent = 'Have account?';
            field.classList.remove('hidden');
        } else {
            btn.textContent = 'Login';
            toggle.textContent = 'Sign Up';
            text.textContent = 'Need account?';
            field.classList.add('hidden');
        }
    };

    window.toggleUserMode = () => {
        const btn = document.getElementById('userBtn');
        const toggle = document.getElementById('userToggle');
        
        if (btn.textContent === 'Login') {
            btn.textContent = 'Sign Up';
            toggle.textContent = 'Login';
        } else {
            btn.textContent = 'Login';
            toggle.textContent = 'Sign Up';
        }
    };

    window.adminAuth = async (e) => {
        e.preventDefault();
        const email = document.getElementById('adminEmail').value;
        const password = document.getElementById('adminPassword').value;
        const isSignUp = document.getElementById('adminBtn').textContent === 'Sign Up';
        
        try {
            if (isSignUp) {
                const code = document.getElementById('adminCode').value;
                if (code !== ADMIN_CODE) {
                    notify('Invalid admin code!', 'error');
                    return;
                }
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "admins", cred.user.uid), { email, createdAt: Timestamp.now() });
                notify('Admin account created!');
            } else {
                await signInWithEmailAndPassword(auth, email, password);
                notify('Logged in successfully!');
            }
        } catch (error) {
            notify(error.message, 'error');
        }
    };

    window.userAuth = async (e) => {
        e.preventDefault();
        const email = document.getElementById('userEmail').value;
        const password = document.getElementById('userPassword').value;
        const isSignUp = document.getElementById('userBtn').textContent === 'Sign Up';
        
        try {
            if (isSignUp) {
                await createUserWithEmailAndPassword(auth, email, password);
                notify('Account created!');
            } else {
                await signInWithEmailAndPassword(auth, email, password);
                notify('Logged in!');
            }
        } catch (error) {
            notify(error.message, 'error');
        }
    };

    window.showModal = (clearance = null) => {
        const modal = document.getElementById('modal');
        const toISODate = (date) => date ? new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0] : '';
        
        modal.innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded p-6 w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">${clearance ? 'Edit' : 'Add'} Clearance</h2>
                    <form onsubmit="saveClearance(event)" class="space-y-4">
                        <input name="ownerName" value="${clearance?.ownerName || ''}" placeholder="Owner Name" class="w-full px-3 py-2 border rounded" required />
                        <input name="vehicleNumber" value="${clearance?.vehicleNumber || ''}" placeholder="Vehicle Number" class="w-full px-3 py-2 border rounded" oninput="this.value=this.value.toUpperCase()" required />
                        <div class="grid grid-cols-2 gap-4">
                            <input name="entryDate" type="date" value="${toISODate(clearance?.entryDate?.toDate())}" class="px-3 py-2 border rounded" required />
                            <input name="expiryDate" type="date" value="${toISODate(clearance?.expiryDate?.toDate())}" class="px-3 py-2 border rounded" required />
                        </div>
                        <input name="location" value="${clearance?.location || ''}" placeholder="Location" class="w-full px-3 py-2 border rounded" required />
                        <textarea name="notes" placeholder="Notes" rows="3" class="w-full px-3 py-2 border rounded">${clearance?.notes || ''}</textarea>
                        <div class="flex items-center">
                            <input type="checkbox" name="escortRequired" class="mr-2" ${clearance?.escortRequired ? 'checked' : ''} />
                            <label>Escort Required</label>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">${clearance ? 'Update' : 'Save'}</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        if (clearance) {
            modal.querySelector('form').dataset.editId = clearance.id;
        }
    };

    window.closeModal = () => {
        document.getElementById('modal').innerHTML = '';
    };

    window.saveClearance = async (e) => {
        e.preventDefault();
        const form = new FormData(e.target);
        const data = {
            ownerName: form.get('ownerName'),
            vehicleNumber: form.get('vehicleNumber').toUpperCase(),
            entryDate: Timestamp.fromDate(new Date(form.get('entryDate'))),
            expiryDate: Timestamp.fromDate(new Date(form.get('expiryDate'))),
            location: form.get('location'),
            notes: form.get('notes') || '',
            escortRequired: form.has('escortRequired'),
            updatedAt: Timestamp.now()
        };
        
        const editId = e.target.dataset.editId;
        if (editId) {
            await updateDoc(doc(db, "vehicleClearances", editId), data);
            notify('Clearance updated!');
        } else {
            await addDoc(collection(db, "vehicleClearances"), { ...data, createdAt: Timestamp.now() });
            notify('Clearance added!');
        }
        closeModal();
    };

    window.deleteClearance = async (id) => {
        if (confirm('Delete this clearance?')) {
            await deleteDoc(doc(db, "vehicleClearances", id));
            notify('Clearance deleted!');
        }
    };

    window.approveRequest = async (id) => {
        const req = requests.find(r => r.id === id);
        if (req) {
            await addDoc(collection(db, "vehicleClearances"), {
                ownerName: req.ownerName,
                vehicleNumber: req.vehicleNumber,
                location: req.location,
                entryDate: req.entryDate,
                expiryDate: req.expiryDate,
                escortRequired: req.escortRequired,
                notes: req.notes || '',
                createdAt: Timestamp.now()
            });
            await updateDoc(doc(db, "clearanceRequests", id), {
                status: "approved",
                approvedAt: Timestamp.now()
            });
            notify('Request approved!');
        }
    };

    window.rejectRequest = async (id) => {
        await updateDoc(doc(db, "clearanceRequests", id), {
            status: "rejected",
            rejectedAt: Timestamp.now()
        });
        notify('Request rejected!');
    };

    const updateRequests = () => {
        const list = document.getElementById('requestsList');
        if (!list) return;
        
        if (requests.length === 0) {
            list.innerHTML = `<div class="text-center p-8 bg-white rounded">No pending requests</div>`;
            return;
        }

        list.innerHTML = requests.map(r => `
            <div class="bg-white rounded shadow p-4 mb-4">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-bold">${r.ownerName}</h3>
                        <p class="font-mono text-blue-600">${r.vehicleNumber}</p>
                        <p class="text-sm text-gray-500">Submitted: ${fmt(r.submittedAt)}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="approveRequest('${r.id}')" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Approve</button>
                        <button onclick="rejectRequest('${r.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm">Reject</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><span class="text-gray-500">Contact:</span> ${r.contactNumber}</div>
                    <div><span class="text-gray-500">Location:</span> ${r.location}</div>
                    <div><span class="text-gray-500">Dates:</span> ${fmt(r.entryDate)} - ${fmt(r.expiryDate)}</div>
                    <div><span class="text-gray-500">Escort:</span> ${r.escortRequired ? 'Yes' : 'No'}</div>
                </div>
                <div class="mt-2 text-sm"><span class="text-gray-500">Purpose:</span> ${r.purpose}</div>
            </div>
        `).join('');
    };

    const updateClearances = () => {
        const list = document.getElementById('clearancesList');
        if (!list) return;
        
        if (clearances.length === 0) {
            list.innerHTML = `<div class="text-center p-8 bg-white rounded">No clearances found</div>`;
            return;
        }

        const sorted = [...clearances].sort((a, b) => b.entryDate.toDate() - a.entryDate.toDate());
        list.innerHTML = sorted.map(c => `
            <div class="bg-white rounded shadow p-4 mb-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold">${c.ownerName}</p>
                        <p class="font-mono text-lg text-blue-600">${c.vehicleNumber}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showModal(${JSON.stringify(c).replace(/"/g, '&quot;')})" class="p-2 text-blue-500 hover:bg-blue-100 rounded">‚úèÔ∏è</button>
                        <button onclick="deleteClearance('${c.id}')" class="p-2 text-red-500 hover:bg-red-100 rounded">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="mt-2 grid grid-cols-2 gap-4 text-sm">
                    <div><span class="text-gray-500">Location:</span> ${c.location}</div>
                    <div><span class="text-gray-500">Valid:</span> ${fmt(c.entryDate)} - ${fmt(c.expiryDate)}</div>
                    <div><span class="text-gray-500">Escort:</span> ${c.escortRequired ? 'Required' : 'Not Required'}</div>
                    <div><span class="text-gray-500">Notes:</span> ${c.notes || 'None'}</div>
                </div>
            </div>
        `).join('');
    };
// Firebase listeners
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const adminDoc = await getDoc(doc(db, "admins", user.uid));
                if (adminDoc.exists()) {
                    adminDash(user);
                    onSnapshot(query(collection(db, "vehicleClearances")), (snap) => {
                        clearances = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        updateClearances();
                    });
                    onSnapshot(query(collection(db, "clearanceRequests"), where("status", "==", "pending")), (snap) => {
                        requests = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        updateRequests();
                    });
                } else {
                    userDash();
                    onSnapshot(query(collection(db, "vehicleClearances")), (snap) => {
                        clearances = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // Refresh user dashboard when clearances update
                        if (document.querySelector('main')) {
                            userDash();
                        }
                    });
                }
            } else {
                home();
            }
        });

        // Initialize the app
        home();

    </script>
</body>
</html>
    
