<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Vehicle Clearance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .dark-theme-bg {
            background-color: #1e293b; /* Dark Slate Blue */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        summary { list-style: none; }
        summary::-webkit-details-marker { display: none; }

        #settings-panel {
            transition: transform 0.3s ease-in-out;
        }
        #settings-backdrop {
            transition: background-color 0.3s ease-in-out;
        }

        .voice-search-btn.listening {
            animation: pulse-ring 1.5s infinite;
            background-color: #ef4444; /* red-500 */
        }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .action-buttons {
            position: relative;
            z-index: 10;
        }
        .action-buttons button {
            pointer-events: auto;
        }

        .settings-tab-btn.active {
            border-color: #3b82f6; /* blue-500 */
            color: #2563eb; /* blue-600 */
        }
        .dark .settings-tab-btn.active {
            border-color: #60a5fa; /* blue-400 */
            color: #60a5fa; /* blue-400 */
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .car-plate-display {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
            border: 4px solid #fbbf24;
            box-shadow:
                0 10px 25px rgba(0, 0, 0, 0.5),
                inset 0 2px 4px rgba(255, 255, 255, 0.1),
                0 0 20px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }
        .car-plate-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shine 3s infinite;
        }
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .car-plate-text {
            font-family: 'Courier New', monospace;
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            letter-spacing: 4px;
            color: white!important;
            font-size: 1.2em;
        }
        .search-highlight {
            color: white!important;
            background: none!important;
            -webkit-background-clip: initial!important;
            -webkit-text-fill-color: white!important;
            background-clip: initial!important;
            animation: glow 2s ease-in-out infinite alternate;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }
        @keyframes glow {
            from { filter: drop-shadow(0 0 5px #fbbf24); }
            to { filter: drop-shadow(0 0 15px #f59e0b); }
        }
        html,
        body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        .mobile-safe-container {
            width: 100%;
            max-width: 100vw;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
        }
        .mobile-text {
            font-size: clamp(0.75rem, 3vw, 1rem);
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        .mobile-vehicle-number {
            font-size: clamp(1rem, 5vw, 1.5rem);
            letter-spacing: 0.05em;
            word-break: break-all;
        }
        .mobile-button {
            min-height: 44px;
            padding: 0.75rem 1rem;
            font-size: clamp(0.875rem, 3.5vw, 1rem);
        }
        .mobile-input {
            width: 100%;
            max-width: 100%;
            font-size: 16px;
            padding: 0.75rem;
            box-sizing: border-box;
        }
        .mobile-grid-fix {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            width: 100%;
        }
        .mobile-details {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }
        .mobile-details summary {
            padding: 0.75rem;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            box-sizing: border-box;
        }
        .mobile-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            min-width: fit-content;
        }
        .mobile-modal {
            position: fixed;
            inset: 0;
            padding: 1rem;
            max-height: 100vh;
            overflow-y: auto;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 2rem;
        }
        .mobile-modal-content {
            width: 100%;
            max-width: 28rem;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            margin: 0 auto;
        }
        @media(max-width: 640px) {
            .responsive-grid {
                grid-template-columns: 1fr!important;
            }
            .ultra-mobile-text {
                font-size: 0.875rem;
            }
            .mobile-button-stack {
                flex-direction: column;
                width: 100%;
                align-items: flex-start!important;
            }
            .mobile-button-stack button {
                width: 100%;
            }
        }
        .landing-bg {
            margin: 0;
            padding: 0;
            position: relative;
            overflow-x: hidden;
        }
        .landing-bg::before {
            content: "";
            position: fixed;
            inset: 0;
            background: url('https://raw.githubusercontent.com/Theva73/Vehicle-Clearance/main/car_logo.jpg') no-repeat center center fixed;
            background-size: cover;
            filter: blur(6px) brightness(0.6);
            z-index: -2;
        }
        .landing-bg::after {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.25); /* soft dark overlay for readability */
            z-index: -1;
        }
        :root {
            --logo-bg: #132434; /* sampled from car_logo.jpg */
        }
        html,
        body {
            height: 100%;
            min-height: 100vh;
            background-color: var(--logo-bg) !important;
        }
        #app-root {
            min-height: 100vh;
        }
        .landing-solid {
            background-color: var(--logo-bg) !important;
        }
    </style>
</head>
<body class="">
    <div id="app-root"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            setDoc,
            deleteDoc,
            onSnapshot,
            query,
            Timestamp,
            getDoc,
            where,
            updateDoc,
            getDocs,
            orderBy,
            writeBatch,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const ADMIN_INVITE_CODE = "ADMIN2025";
        const DEFAULT_USER_PASSWORD = "123456";
        const GEMINI_API_KEY = ""; // Kept empty as per instructions
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const firebaseConfig = {
            apiKey: "AIzaSyC51Zo7V75JjOpLOdusf6ZKUzEG_gqFcV4",
            authDomain: "vehicle-clearance.firebaseapp.com",
            projectId: "vehicle-clearance",
            storageBucket: "vehicle-clearance.appspot.com",
            messagingSenderId: "187403368572",
            appId: "1:187403368572:web:1f94845da67ef0c7ccf1f9"
        };

        // --- App Initialization ---
        const appRoot = document.getElementById("app-root");
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch (err) {
            console.error("Firebase initialization error:", err);
            appRoot.innerHTML = '<div class="p-8 text-center text-red-500 bg-red-100 rounded-lg"><b>Error:</b> Firebase initialization failed. Check console for details.</div>';
        }

        // --- State Management ---
        let clearances = [];
        let clearanceRequests = [];
        let vvips = [];
        let userPasswordConfig = null;
        let currentAdminProfile = null;
        let unsubClearances = null,
            unsubRequests = null,
            unsubConfig = null,
            unsubVVIPs = null;
        let authMode = "login";
        let routeHistory = [];

        // --- Gemini API & Email Notification Helpers ---
        const callGeminiApi = async (prompt, maxRetries = 3) => {
            let attempts = 0;
            while (attempts < maxRetries) {
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                    };
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid response structure from Gemini API.");
                    }

                } catch (error) {
                    attempts++;
                    console.error(`Gemini API call attempt ${attempts} failed:`, error);
                    if (attempts >= maxRetries) {
                        throw error;
                    }
                    const delay = Math.pow(2, attempts) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        };
        
        const sendEmail = async (to, subject, htmlBody) => {
            console.log("--- EMAIL SIMULATION ---");
            console.log(`To: ${to}`);
            console.log(`Subject: ${subject}`);
            console.log("Body (HTML):");
            console.log(htmlBody);
            console.log("--- END EMAIL SIMULATION ---");
            showNotification(`Email notification sent to ${to}.`, "success");
        };
        
        // --- MODIFICATION START: Voice Search Implementation Updated ---
        const audioContext = new(window.AudioContext || window.webkitAudioContext)();
        const playBeep = (frequency = 440, duration = 100, type = 'sine') => {
            if (!audioContext) return;
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration / 1000);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + duration / 1000);
            } catch (error) {
                console.error("Beep playback failed:", error);
            }
        };

        let recognition = null;
        let isVoiceSearchActive = false;
        let voiceSearchTimeout = null;
        let currentVoiceInput = null;
        let currentVoiceButton = null;

        const initializeVoiceRecognition = () => {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech recognition not supported');
                return false;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isVoiceSearchActive = true;
                if (currentVoiceButton) currentVoiceButton.classList.add('listening');
            };
            recognition.onresult = (event) => handleVoiceResult(event);
            recognition.onerror = (event) => {
                let errorMessage = 'An error occurred during voice recognition.';
                if (event.error === 'no-speech') errorMessage = 'No speech detected. Please try again.';
                else if (event.error === 'not-allowed') errorMessage = 'Microphone permission denied.';
                showNotification(errorMessage, "error");
                stopVoiceSearch();
            };
            recognition.onend = () => {
                if (isVoiceSearchActive) stopVoiceSearch();
            };

            return true;
        };

        const processVehicleNumber = (spokenText) => {
            let processed = spokenText.toLowerCase().trim();
            const fillerWords = ['um', 'uh', 'the', 'number', 'is', 'vehicle', 'car', 'plate'];
            fillerWords.forEach(word => {
                processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), ' ');
            });
            const numberMappings = [
                ['zero', '0'], ['oh', '0'], ['o', '0'], ['one', '1'], ['won', '1'],
                ['two', '2'], ['to', '2'], ['too', '2'], ['three', '3'], ['tree', '3'],
                ['four', '4'], ['for', '4'], ['fore', '4'], ['five', '5'], ['fife', '5'],
                ['six', '6'], ['sex', '6'], ['seven', '7'], ['sven', '7'],
                ['eight', '8'], ['ate', '8'], ['nine', '9'], ['nein', '9']
            ];
            numberMappings.forEach(([word, digit]) => {
                processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), ` ${digit} `);
            });
            const digitMatches = processed.match(/\d+/g);
            return digitMatches ? digitMatches.join('') : '';
        };

        const isValidVehicleNumber = (vehicleNumber) => {
            if (!vehicleNumber) return false;
            if (vehicleNumber.length < 1 || vehicleNumber.length > 8) return false; // Logic from standalone script
            return /^\d+$/.test(vehicleNumber);
        };

        const handleVoiceResult = (event) => {
            let transcript = event.results[0][0].transcript;
            let detectedNumber = processVehicleNumber(transcript);
            if (isValidVehicleNumber(detectedNumber)) {
                completeVoiceSearch(detectedNumber);
            } else {
                showNotification(`Could not detect a valid number from "${transcript}"`, "error");
                stopVoiceSearch();
            }
        };

        const startVoiceSearch = (inputElement, buttonElement) => {
            if (!recognition) {
                if (!initializeVoiceRecognition()) {
                    showNotification("Voice search not supported on this device", "error");
                    return;
                }
            }
            if (isVoiceSearchActive) {
                stopVoiceSearch();
                return;
            }
            currentVoiceInput = inputElement;
            currentVoiceButton = buttonElement;
            try {
                playBeep(523, 150);
                recognition.start();
                voiceSearchTimeout = setTimeout(() => {
                    showNotification("Voice search timed out.", "error");
                    stopVoiceSearch();
                }, 8000);
            } catch (error) {
                showNotification("Failed to start voice search", "error");
            }
        };

        const stopVoiceSearch = () => {
            if (!isVoiceSearchActive) return;
            playBeep(392, 150);
            if (recognition) recognition.stop();
            if (voiceSearchTimeout) clearTimeout(voiceSearchTimeout);
            if (currentVoiceButton) currentVoiceButton.classList.remove('listening');
            isVoiceSearchActive = false;
            currentVoiceInput = null;
            currentVoiceButton = null;
            voiceSearchTimeout = null;
        };
        
        const completeVoiceSearch = (detectedNumber) => {
            if (currentVoiceInput && detectedNumber) {
                currentVoiceInput.value = detectedNumber;
                currentVoiceInput.dispatchEvent(new Event('input', { bubbles: true }));
                showNotification(`Vehicle number "${detectedNumber}" detected!`);
            }
            stopVoiceSearch();
        };
        // --- MODIFICATION END: Voice Search Implementation Updated ---
        // --- NEW DATABASE FUNCTIONS ---
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; // Earth’s radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in meters
        };
        const getCurrentLocation = () => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation not supported by this browser"));
                    return;
                }
                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 300000 // 5 minutes
                };
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        let errorMessage;
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Location permission denied. Please enable location access.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Location information unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Location request timed out.";
                                break;
                            default:
                                errorMessage = "An unknown error occurred while getting location.";
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    options
                );
            });
        };
        const validateUserID = async (userID) => {
            try {
                const q = query(collection(db, "authorizedUsers"), where("userId", "==", userID), where("isActive", "==", true));
                const querySnapshot = await getDocs(q);
                return querySnapshot.empty ? null : { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
            } catch (error) {
                console.error("Error validating user ID:", error);
                return null;
            }
        };
        const getAllowedLocations = async () => {
            try {
                const q = query(collection(db, "allowedLocations"), where("isActive", "==", true));
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error getting allowed locations:", error);
                return [];
            }
        };
        const checkLocationAccess = async (userLocation, allowedLocations) => {
            if (!userLocation || !allowedLocations.length) {
                return { allowed: false, reason: "No valid locations configured" };
            }
            for (const location of allowedLocations) {
                const distance = calculateDistance(
                    userLocation.latitude, userLocation.longitude,
                    location.latitude, location.longitude
                );
                let effectiveRadius = location.radiusMeters;
                if (userLocation.accuracy > 50) {
                    effectiveRadius += Math.min(userLocation.accuracy * 0.5, 100);
                }
                if (distance <= effectiveRadius) {
                    return {
                        allowed: true,
                        locationName: location.name,
                        distance: Math.round(distance),
                        method: 'gps'
                    };
                }
            }
            return {
                allowed: false,
                reason: "You are not within an authorized location",
                nearestLocation: findNearestLocation(userLocation, allowedLocations)
            };
        };
        const findNearestLocation = (userLocation, allowedLocations) => {
            if (!allowedLocations.length) return null;
            let nearest = allowedLocations[0];
            let minDistance = calculateDistance(
                userLocation.latitude, userLocation.longitude,
                nearest.latitude, nearest.longitude
            );
            for (const location of allowedLocations.slice(1)) {
                const distance = calculateDistance(
                    userLocation.latitude, userLocation.longitude,
                    location.latitude, location.longitude
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = location;
                }
            }
            return { name: nearest.name, distance: Math.round(minDistance) };
        };
        const logAccessAttempt = async (userID, userLocation, accessGranted, reason) => {
            try {
                const logData = {
                    userId: userID,
                    location: userLocation,
                    locationName: null,
                    accessGranted,
                    reason,
                    timestamp: Timestamp.now(),
                    userAgent: navigator.userAgent,
                    ipAddress: null
                };
                if (accessGranted && userLocation) {
                    const allowedLocations = await getAllowedLocations();
                    const locationCheck = await checkLocationAccess(userLocation, allowedLocations);
                    if (locationCheck.allowed) {
                        logData.locationName = locationCheck.locationName;
                    }
                }
                await addDoc(collection(db, "accessLogs"), logData);
            } catch (error) {
                console.error("Error logging access attempt:", error);
            }
        };
        const updateLastUsed = async (authorizedUserId) => {
            try {
                await updateDoc(doc(db, "authorizedUsers", authorizedUserId), {
                    lastUsed: Timestamp.now()
                });
            } catch (error) {
                console.error("Error updating last used:", error);
            }
        };

        // --- Utility Functions ---
        const goBack = () => {
            if (routeHistory.length > 0) {
                const renderPrevious = routeHistory.pop();
                renderPrevious();
            } else {
                renderLandingPage();
            }
        };

        const formatDate = (date) => {
            if (!date) return "N/A";
            const d = date instanceof Date ? date : date.toDate();
            return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getFullYear()).slice(-2)}`;
        };
        const formatDateLongForm = (date) => {
            if (!date) return "N/A";
            const d = date instanceof Date ? date : date.toDate();
            return d.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };

        const formatVehicleNumber = (vehicleNumber) => {
            if (!vehicleNumber) return 'N/A';
            return vehicleNumber.toUpperCase();
        };
        const formatApprovalString = (clearance) => {
            if (clearance.approvedAt && clearance.approvedByUsername) {
                const date = formatDate(clearance.approvedAt);
                const time = clearance.approvedAt.toDate().toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                return `Approved by ${clearance.approvedByUsername} (${clearance.approvedByDesignation || 'Admin'}) on ${date} at ${time}hrs`;
            }
            return null;
        }
        const formatUpdateString = (clearance) => {
            if (clearance.lastUpdatedAt && clearance.lastUpdatedByUsername) {
                const date = formatDate(clearance.lastUpdatedAt);
                const time = clearance.lastUpdatedAt.toDate().toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                return `Last updated by ${clearance.lastUpdatedByUsername} (${clearance.lastUpdatedByDesignation || 'Admin'}) on ${date} at ${time}hrs`;
            }
            return null;
        }
        const formatApprovalHistory = (clearance) => {
            if (!clearance.approvalHistory || clearance.approvalHistory.length === 0) {
                return '';
            }
            return clearance.approvalHistory.map(entry => {
                const date = formatDate(entry.timestamp);
                const time = entry.timestamp.toDate().toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                const actionText = entry.action.charAt(0).toUpperCase() + entry.action.slice(1);
                return `${actionText} by ${entry.byUsername} (${entry.byDesignation}) on ${date} at ${time}hrs`;
            }).join('<br>');
        }

        const toISODate = d => d ? new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split("T")[0] : "";
        const getFormObj = form => Object.fromEntries(new FormData(form).entries());
        const showNotification = (message, type = "success") => {
            const notification = document.createElement("div");
            const bgColor = type === "success" ? "bg-green-500" : type === "error" ? "bg-red-500" : "bg-blue-500";
            notification.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white flex items-center animate-fade-in z-[100] ${bgColor} max-w-sm`;
            const icon = type === "success" ? "✓" : type === "error" ? "✗" : "ℹ";
            notification.innerHTML = `<span class="mr-3 text-lg">${icon}</span><span>${message}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        };
        const parseLocalDate = (dateString) => {
            if (!dateString) return null;
            const parts = dateString.split('-');
            if (parts.length !== 3) return null;
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const day = parseInt(parts[2], 10);
            if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
            return new Date(year, month, day);
        };

        const performSecureLogout = async () => {
            try {
                const currentUserID = sessionStorage.getItem('currentUserID');
                if (currentUserID) {
                    await logAccessAttempt(currentUserID, null, true, "User logged out");
                }
                sessionStorage.removeItem('isDashboardLogin');
                sessionStorage.removeItem('currentUserID');
                sessionStorage.removeItem('accessLocation');
                await signOut(auth);
                showNotification("Logged out successfully");
            } catch (error) {
                console.error("Logout error:", error);
                showNotification("Logout completed", "success");
            }
        };
        const isValidSecureSession = () => {
            return sessionStorage.getItem('isDashboardLogin') === 'true' &&
                sessionStorage.getItem('currentUserID') !== null;
        };
        // — Icon Library —
        const icons = {
            car: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2,16H46" /><path d="M6,16 C6,16 6,12 10,8 C14,4 18,4 24,4 C30,4 34,4 38,8 C42,12 42,16 42,16" /><path d="M8 20a2 2 0 100-4 2 2 0 000 4z" /><path d="M40 20a2 2 0 100-4 2 2 0 000 4z" /></svg>`,
            logout: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            edit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
            shield: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`,
            greenlist: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
            sun: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
            request: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"></path><path d="M9 18h6"></path><path d="M2 22v-2a4 4 0 0 1 4-4h12a4 4 0 0 1 4 4v2"></path></svg>`,
            search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>`,
            mic: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
            chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`,
            download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
            settings: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V15a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
            star: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`,
            sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3L9.5 8.5L4 11L9.5 13.5L12 19L14.5 13.5L20 11L14.5 8.5L12 3z"/><path d="M5 3v4h4"/><path d="M19 17v4h-4"/></svg>`,
            database: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>`
        };
        // — Dashboard Setup —
        const showUserDashboard = (user) => {
            appRoot.innerHTML = `<div class="min-h-screen flex items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div></div>`;
            document.body.classList.remove('dark-theme-bg');
            document.body.classList.add('bg-gray-100', 'dark:bg-gray-900');
            unsubClearances = onSnapshot(collection(db, "vehicleClearances"), snap => {
                clearances = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderUserDashboard(user);
            });
            unsubVVIPs = onSnapshot(query(collection(db, "vvips"), orderBy("vehicleNumber")), snap => {
                vvips = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        };
        // --- PDF Generation Function ---
        const generatePDFReport = async (button) => { /* ... Function content is unchanged ... */ };
        // --- DATABASE MANAGEMENT FUNCTIONS ---
        const clearAllDatabaseData = async (button) => { /* ... Function content is unchanged ... */ };
        const resetToDefaultState = async (button) => { /* ... Function content is unchanged ... */ };
        const exportDatabaseData = async (button) => { /* ... Function content is unchanged ... */ };
        const updateDatabaseStats = async () => { /* ... Function content is unchanged ... */ };
        
        // — Render Functions —
        const renderLandingPage = (options = {}) => { /* ... Function content is unchanged ... */ };
        const renderAdminLogin = () => { /* ... Function content is unchanged ... */ };
        const renderUserLogin = () => { /* ... Function content is unchanged ... */ };

        // --- MODIFICATION START: Expiry date input is now readonly ---
        const renderRequestForm = () => {
            document.body.className = 'dark-theme-bg';

            const now = new Date();
            const cutOffHour = 14;
            let minDate = new Date();

            if (now.getHours() >= cutOffHour) {
                minDate.setDate(minDate.getDate() + 1);
            }

            const minDateString = minDate.toISOString().split('T')[0];
            appRoot.innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-lg mobile-safe-container bg-slate-800/80 backdrop-blur-sm border border-yellow-500/20 rounded-2xl shadow-2xl shadow-yellow-900/20 p-8 space-y-6 animate-fade-in">
                <div class="text-center">
                    <div class="w-12 h-12 mx-auto text-yellow-400">${icons.request}</div>
                    <h1 class="text-3xl font-bold text-white mt-4">Request Vehicle Clearance</h1>
                    <p class="text-slate-400">Fill in the details below</p>
                </div>
                <form id="request-form" class="space-y-4 text-left">
                    <div>
                        <label class="text-sm font-medium text-slate-300">Your Name</label>
                        <input name="requesterName" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" placeholder="e.g. John Doe" required />
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-300">Your Email Address</label>
                        <input type="email" name="requesterEmail" placeholder="you@example.com" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required />
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-300">Vehicle Number</label>
                        <input name="vehicleNumber" oninput="this.value=this.value.toUpperCase()" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required />
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-300">Vehicle Type</label>
                        <select name="vehicleType" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required>
                            <option value="">Select type...</option>
                            <option>Car</option><option>Motorcycle</option><option>Van</option><option>Tow Truck</option><option>Lorry</option><option>Bus</option><option>Others</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-300">Location</label>
                        <select name="location" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required>
                            <option value="PCC" selected>PCC</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-300">Visiting Hours</label>
                        <select name="timeSlot" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required>
                            <option value="">Select a time slot...</option>
                            <option value="08:00-13:00">08:00 to 13:00</option>
                            <option value="08:00-18:00">08:00 to 18:00</option>
                            <option value="13:00-18:00">13:00 to 18:00</option>
                            <option value="18:00-onwards">18:00 onwards</option>
                        </select>
                        <p class="text-xs text-slate-400 mt-2">Note: Approval is subject to parking lot availability.</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-slate-300">Entry Date</label>
                            <input type="date" name="entryDate" min="${minDateString}" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" required />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-300">Expiry Date (auto-set)</label>
                            <input type="date" name="expiryDate" min="${minDateString}" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white read-only:bg-slate-700" required readonly />
                        </div>
                    </div>
                    <p class="text-xs text-yellow-400 mt-2">For same-day clearance, requests must be submitted before 14:00hrs local time.</p>
                    <div>
                        <label class="text-sm font-medium text-slate-300">Notes</label>
                        <textarea name="notes" rows="3" class="mobile-input mt-1 w-full p-3 bg-slate-900/70 border border-slate-700 rounded-lg text-white" placeholder="Purpose of entry"></textarea>
                    </div>
                    <div class="flex justify-between pt-4">
                        <button id="back-btn" type="button" class="px-6 py-2 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 mobile-button">Back</button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 mobile-button">Submit</button>
                    </div>
                </form>
            </div>
        </div>`;
        };
        // --- MODIFICATION END ---

        const createStatusCard = (r) => { /* ... Function content is unchanged ... */ };
        const findCurrentVehicleStatus = async (vehicleNumber) => { /* ... Function content is unchanged ... */ };
        const renderClearanceListForUser = (vehicleFilter = null) => { /* ... Function content is unchanged ... */ };
        const renderUserDashboard = (user, vehicleFilter = null) => { /* ... Function content is unchanged ... */ };
        const renderAdminDashboard = (adminUser) => { /* ... Function content is unchanged ... */ };
        const renderRequestsList = () => { /* ... Function content is unchanged ... */ };
        const renderClearancesList = () => { /* ... Function content is unchanged ... */ };
        const renderVVIPListForSettings = () => { /* ... Function content is unchanged ... */ };
        const renderVVIPModal = () => { /* ... Function content is unchanged ... */ };
        const renderReviewModal = (request) => { /* ... Function content is unchanged ... */ };
        const renderModal = (edit = null) => { /* ... Function content is unchanged ... */ };
        const renderConfirmationModal = (title, message, onConfirm) => { /* ... Function content is unchanged ... */ };
        const renderRejectionModal = (requestId) => { /* ... Function content is unchanged ... */ };
        const toggleSettingsPanel = (show) => { /* ... Function content is unchanged ... */ };
        const renderAuthorizedUsersList = async () => { /* ... Function content is unchanged ... */ };
        const renderAllowedLocationsList = async () => { /* ... Function content is unchanged ... */ };
        const renderAccessLogsList = async () => { /* ... Function content is unchanged ... */ };
        const handleSecureUserLogin = async (enteredUserID) => { /* ... Function content is unchanged ... */ };

        // — Auth State Listener —
        onAuthStateChanged(auth, async (user) => { /* ... Function content is unchanged ... */ });

        const handleEscortCheckboxChange = (checkbox, textareaId) => { /* ... Function content is unchanged ... */ };

        // --- Global Event Listener ---
        document.body.addEventListener("click", async (e) => { /* ... Function content is unchanged ... */ });
        
        // --- Form submission event handler ---
        document.body.addEventListener("submit", async (e) => { /* ... Function content is unchanged ... */ });

        // --- MODIFICATION START: Added logic to sync expiry date on the request form ---
        document.body.addEventListener("change", (e) => {
            if (e.target.name === "location") {
                const customInput = e.target.closest('form')?.querySelector('input[name="customLocation"]');
                if (customInput) {
                    if (e.target.value === "Other") {
                        customInput.classList.remove('hidden');
                        customInput.required = true;
                    } else {
                        customInput.classList.add('hidden');
                        customInput.required = false;
                        customInput.value = '';
                    }
                }
            }

            if (e.target.name === "escortRequired") {
                const reviewModal = e.target.closest('#review-modal-backdrop');
                const formModal = e.target.closest('#form-modal-backdrop');
                let textareaId = null;
                if (reviewModal) textareaId = 'review-notes-textarea';
                else if (formModal) textareaId = 'modal-notes-textarea';
                if (textareaId) handleEscortCheckboxChange(e.target, textareaId);
            }
            
            // New logic for entry/expiry date sync on request form
            if (e.target.name === "entryDate") {
                const requestForm = e.target.closest('#request-form');
                if (requestForm) {
                    const expiryDateInput = requestForm.querySelector('input[name="expiryDate"]');
                    if (expiryDateInput) {
                        expiryDateInput.value = e.target.value;
                        expiryDateInput.min = e.target.value; // Also sync the min attribute
                    }
                }
            }
        });
        // --- MODIFICATION END ---
        
        document.body.addEventListener("input", e => {
            if (e.target.id === 'daily-clearance-search-input') {
                renderClearanceListForUser(e.target.value.toUpperCase());
            }
        });

        document.body.addEventListener("reset", e => {
            if (e.target.id === "daily-clearance-search-form") {
                setTimeout(() => renderClearanceListForUser(null), 0);
            }
        });
        
        window.addEventListener('load', () => {
            initializeVoiceRecognition();
        });

        renderLandingPage();
    </script>
</body>
</html>

