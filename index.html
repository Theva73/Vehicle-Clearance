import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    onAuthStateChanged, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    signOut 
} from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    doc, 
    addDoc, 
    setDoc, 
    deleteDoc, 
    onSnapshot, 
    query, 
    where, 
    Timestamp,
    getDoc
} from 'firebase/firestore';
import { CheckCircle, XCircle, PlusCircle, LogIn, LogOut, ShieldCheck, User, Car, Calendar, MapPin, Shield, Edit, Trash2, Sun } from 'lucide-react';

// --- Firebase Configuration ---
// IMPORTANT: Replace with your actual Firebase project configuration.
const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
const firebaseConfig = JSON.parse(firebaseConfigString);

// --- Initialize Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Helper Components ---

const Modal = ({ children, onClose }) => (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md relative animate-fade-in-up">
            <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                <XCircle size={24} />
            </button>
            {children}
        </div>
    </div>
);

const LoadingSpinner = () => (
    <div className="flex justify-center items-center h-full">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>
);

const Notification = ({ message, type, onDismiss }) => {
    if (!message) return null;
    const baseClasses = "fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white flex items-center animate-fade-in-up";
    const typeClasses = {
        success: "bg-green-500",
        error: "bg-red-500",
    };
    const Icon = type === 'success' ? CheckCircle : XCircle;

    useEffect(() => {
        const timer = setTimeout(() => {
            onDismiss();
        }, 5000);
        return () => clearTimeout(timer);
    }, [onDismiss]);

    return (
        <div className={`${baseClasses} ${typeClasses[type]}`}>
            <Icon className="mr-3" size={24} />
            <span>{message}</span>
        </div>
    );
};


// --- Main App Components ---

const AuthScreen = ({ setNotification }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [isLogin, setIsLogin] = useState(true);
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
            if (isLogin) {
                await signInWithEmailAndPassword(auth, email, password);
                setNotification({ type: 'success', message: 'Logged in successfully!' });
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
                setNotification({ type: 'success', message: 'Account created! Please log in.' });
                setIsLogin(true); // Switch to login view after sign up
            }
        } catch (error) {
            console.error("Authentication error:", error);
            setNotification({ type: 'error', message: error.message });
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-900 p-4">
            <div className="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 space-y-6">
                <div className="text-center">
                    <Car size={48} className="mx-auto text-blue-500" />
                    <h1 className="text-3xl font-bold text-gray-800 dark:text-white mt-4">Vehicle Clearance</h1>
                    <p className="text-gray-500 dark:text-gray-400">{isLogin ? 'Sign in to your account' : 'Create a new account'}</p>
                </div>
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div>
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                        <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            placeholder="you@example.com"
                            required
                        />
                    </div>
                    <div>
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="mt-1 block w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            placeholder="••••••••"
                            required
                        />
                    </div>
                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300"
                    >
                        {loading ? 'Processing...' : (isLogin ? 'Login' : 'Sign Up')}
                    </button>
                </form>
                <p className="text-center text-sm text-gray-500 dark:text-gray-400">
                    {isLogin ? "Don't have an account?" : "Already have an account?"}
                    <button onClick={() => setIsLogin(!isLogin)} className="font-medium text-blue-600 hover:text-blue-500 ml-1">
                        {isLogin ? 'Sign Up' : 'Login'}
                    </button>
                </p>
            </div>
        </div>
    );
};

const ClearanceForm = ({ onSave, onCancel, clearance, setNotification }) => {
    const [formData, setFormData] = useState({
        ownerName: '',
        vehicleNumber: '',
        entryDate: '',
        expiryDate: '',
        location: '',
        escortRequired: false,
        notes: ''
    });

    useEffect(() => {
        if (clearance) {
            setFormData({
                ownerName: clearance.ownerName,
                vehicleNumber: clearance.vehicleNumber,
                entryDate: clearance.entryDate.toDate().toISOString().split('T')[0],
                expiryDate: clearance.expiryDate.toDate().toISOString().split('T')[0],
                location: clearance.location,
                escortRequired: clearance.escortRequired,
                notes: clearance.notes,
            });
        }
    }, [clearance]);

    const handleChange = (e) => {
        const { name, value, type, checked } = e.target;
        setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (new Date(formData.expiryDate) < new Date(formData.entryDate)) {
            setNotification({ type: 'error', message: 'Expiry date cannot be before entry date.' });
            return;
        }
        
        const dataToSave = {
            ...formData,
            entryDate: Timestamp.fromDate(new Date(formData.entryDate)),
            expiryDate: Timestamp.fromDate(new Date(formData.expiryDate)),
        };

        onSave(dataToSave);
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <h2 className="text-2xl font-bold text-gray-800 dark:text-white">{clearance ? 'Edit' : 'Add'} Vehicle Clearance</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input name="ownerName" value={formData.ownerName} onChange={handleChange} placeholder="Owner's Name / Company" className="p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg" required />
                <input name="vehicleNumber" value={formData.vehicleNumber} onChange={handleChange} placeholder="Vehicle Number" className="p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg" required />
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="text-sm text-gray-500 dark:text-gray-400">Entry Date</label>
                    <input type="date" name="entryDate" value={formData.entryDate} onChange={handleChange} className="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg" required />
                </div>
                <div>
                    <label className="text-sm text-gray-500 dark:text-gray-400">Expiry Date</label>
                    <input type="date" name="expiryDate" value={formData.expiryDate} onChange={handleChange} className="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg" required />
                </div>
            </div>

            <input name="location" value={formData.location} onChange={handleChange} placeholder="Location" className="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg" required />
            
            <textarea name="notes" value={formData.notes} onChange={handleChange} placeholder="Notes" rows="3" className="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg"></textarea>
            
            <div className="flex items-center">
                <input type="checkbox" id="escortRequired" name="escortRequired" checked={formData.escortRequired} onChange={handleChange} className="h-5 w-5 text-blue-600 rounded" />
                <label htmlFor="escortRequired" className="ml-2 text-gray-700 dark:text-gray-300">Escort Required</label>
            </div>

            <div className="flex justify-end space-x-3 pt-4">
                <button type="button" onClick={onCancel} className="px-6 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300">Cancel</button>
                <button type="submit" className="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">{clearance ? 'Update' : 'Save'}</button>
            </div>
        </form>
    );
};

const AdminPanel = ({ clearances, setNotification }) => {
    const [showModal, setShowModal] = useState(false);
    const [editingClearance, setEditingClearance] = useState(null);

    const handleSave = async (data) => {
        try {
            if (editingClearance) {
                await setDoc(doc(db, "vehicleClearances", editingClearance.id), data);
                setNotification({ type: 'success', message: 'Clearance updated successfully!' });
            } else {
                await addDoc(collection(db, "vehicleClearances"), { ...data, createdAt: Timestamp.now() });
                setNotification({ type: 'success', message: 'Clearance added successfully!' });
            }
            closeModal();
        } catch (error) {
            console.error("Error saving clearance:", error);
            setNotification({ type: 'error', message: 'Failed to save clearance.' });
        }
    };

    const handleDelete = async (id) => {
        if (window.confirm("Are you sure you want to delete this clearance?")) {
            try {
                await deleteDoc(doc(db, "vehicleClearances", id));
                setNotification({ type: 'success', message: 'Clearance deleted.' });
            } catch (error) {
                console.error("Error deleting clearance:", error);
                setNotification({ type: 'error', message: 'Failed to delete clearance.' });
            }
        }
    };

    const openModal = (clearance = null) => {
        setEditingClearance(clearance);
        setShowModal(true);
    };

    const closeModal = () => {
        setEditingClearance(null);
        setShowModal(false);
    };

    return (
        <div className="p-4 md:p-8">
            <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Admin Dashboard</h1>
                <button onClick={() => openModal()} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <PlusCircle size={20} />
                    Add Clearance
                </button>
            </div>
            
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left">
                        <thead className="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th className="p-4 font-semibold text-gray-600 dark:text-gray-300">Owner</th>
                                <th className="p-4 font-semibold text-gray-600 dark:text-gray-300">Vehicle No.</th>
                                <th className="p-4 font-semibold text-gray-600 dark:text-gray-300">Entry</th>
                                <th className="p-4 font-semibold text-gray-600 dark:text-gray-300">Expiry</th>
                                <th className="p-4 font-semibold text-gray-600 dark:text-gray-300">Location</th>
                                <th className="p-4 font-semibold text-gray-600 dark:text-gray-300">Escort</th>
                                <th className="p-4 font-semibold text-gray-600 dark:text-gray-300">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                            {clearances.map(c => (
                                <tr key={c.id} className="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <td className="p-4 text-gray-800 dark:text-gray-200">{c.ownerName}</td>
                                    <td className="p-4 text-gray-800 dark:text-gray-200 font-mono">{c.vehicleNumber}</td>
                                    <td className="p-4 text-gray-600 dark:text-gray-400">{c.entryDate.toDate().toLocaleDateString()}</td>
                                    <td className="p-4 text-gray-600 dark:text-gray-400">{c.expiryDate.toDate().toLocaleDateString()}</td>
                                    <td className="p-4 text-gray-800 dark:text-gray-200">{c.location}</td>
                                    <td className="p-4">{c.escortRequired ? <CheckCircle className="text-green-500" /> : <XCircle className="text-red-500" />}</td>
                                    <td className="p-4 flex gap-2">
                                        <button onClick={() => openModal(c)} className="p-2 text-blue-500 hover:text-blue-700"><Edit size={18} /></button>
                                        <button onClick={() => handleDelete(c.id)} className="p-2 text-red-500 hover:text-red-700"><Trash2 size={18} /></button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                 {clearances.length === 0 && <p className="p-8 text-center text-gray-500">No vehicle clearances found. Add one to get started!</p>}
            </div>

            {showModal && (
                <Modal onClose={closeModal}>
                    <ClearanceForm onSave={handleSave} onCancel={closeModal} clearance={editingClearance} setNotification={setNotification} />
                </Modal>
            )}
        </div>
    );
};

const UserPanel = ({ clearances }) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const dailyClearances = useMemo(() => clearances.filter(c => {
        const entryDate = c.entryDate.toDate();
        entryDate.setHours(0, 0, 0, 0);
        return entryDate.getTime() === today.getTime();
    }), [clearances]);

    return (
        <div className="p-4 md:p-8">
            <div className="flex items-center gap-4 mb-6">
                 <Sun size={32} className="text-yellow-500"/>
                 <div>
                    <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Daily Vehicle Clearances</h1>
                    <p className="text-gray-500 dark:text-gray-400">Showing vehicles cleared for today: {today.toLocaleDateString()}</p>
                 </div>
            </div>

            <div className="space-y-4">
                {dailyClearances.length > 0 ? dailyClearances.map(c => (
                    <div key={c.id} className="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-5 grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                        <div>
                            <p className="text-sm text-gray-500 dark:text-gray-400">Owner</p>
                            <p className="font-bold text-gray-800 dark:text-white">{c.ownerName}</p>
                        </div>
                        <div>
                            <p className="text-sm text-gray-500 dark:text-gray-400">Vehicle No.</p>
                            <p className="font-mono font-bold text-blue-500 dark:text-blue-400">{c.vehicleNumber}</p>
                        </div>
                        <div>
                            <p className="text-sm text-gray-500 dark:text-gray-400">Location</p>
                            <p className="font-semibold text-gray-800 dark:text-white">{c.location}</p>
                        </div>
                        <div>
                            <p className="text-sm text-gray-500 dark:text-gray-400">Escort</p>
                            {c.escortRequired ? 
                                <span className="flex items-center gap-2 text-green-600 dark:text-green-400 font-semibold"><CheckCircle size={18}/> Required</span> : 
                                <span className="flex items-center gap-2 text-red-600 dark:text-red-400 font-semibold"><XCircle size={18}/> Not Required</span>
                            }
                        </div>
                    </div>
                )) : (
                    <div className="text-center py-16 bg-white dark:bg-gray-800 rounded-2xl shadow-md">
                        <Car size={48} className="mx-auto text-gray-400" />
                        <h3 className="mt-4 text-xl font-semibold text-gray-800 dark:text-white">No Clearances for Today</h3>
                        <p className="mt-1 text-gray-500 dark:text-gray-400">There are no vehicles scheduled for clearance today.</p>
                    </div>
                )}
            </div>
        </div>
    );
};

// --- Main App Component ---
export default function App() {
    const [user, setUser] = useState(null);
    const [isAdmin, setIsAdmin] = useState(false);
    const [loading, setLoading] = useState(true);
    const [clearances, setClearances] = useState([]);
    const [notification, setNotification] = useState({ message: '', type: 'success' }); // {message, type}

    useEffect(() => {
        const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
            setLoading(true);
            if (currentUser) {
                setUser(currentUser);
                // Check for admin role
                const adminDocRef = doc(db, "admins", currentUser.uid);
                const adminDoc = await getDoc(adminDocRef);
                setIsAdmin(adminDoc.exists());
            } else {
                setUser(null);
                setIsAdmin(false);
            }
            setLoading(false);
        });

        return () => unsubscribeAuth();
    }, []);

    useEffect(() => {
        if (!user) {
            setClearances([]);
            return;
        }

        const q = query(collection(db, "vehicleClearances"));
        const unsubscribeFirestore = onSnapshot(q, (snapshot) => {
            const clearanceData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Sort by entry date descending for admin view
            clearanceData.sort((a, b) => b.entryDate.toDate() - a.entryDate.toDate());
            setClearances(clearanceData);
        }, (error) => {
            console.error("Firestore snapshot error:", error);
            setNotification({ type: 'error', message: 'Could not fetch data.' });
        });

        return () => unsubscribeFirestore();
    }, [user]);

    const handleLogout = async () => {
        await signOut(auth);
        setNotification({ type: 'success', message: 'Logged out successfully.' });
    };

    const clearNotification = () => setNotification({ message: '', type: 'success' });

    if (loading) {
        return (
            <div className="min-h-screen bg-gray-100 dark:bg-gray-900">
                <LoadingSpinner />
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">
            <Notification message={notification.message} type={notification.type} onDismiss={clearNotification} />
            
            {!user ? (
                <AuthScreen setNotification={setNotification} />
            ) : (
                <>
                    <header className="bg-white dark:bg-gray-800 shadow-md">
                        <nav className="container mx-auto px-4 md:px-8 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <Car className="text-blue-500" size={28}/>
                                <span className="text-xl font-bold">Vehicle Clearance</span>
                                {isAdmin ? 
                                    <span className="flex items-center gap-1.5 text-sm font-semibold bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded-full"><ShieldCheck size={14}/> Admin</span> :
                                    <span className="flex items-center gap-1.5 text-sm font-semibold bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full"><User size={14}/> User</span>
                                }
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="text-sm text-gray-600 dark:text-gray-400 hidden md:block">{user.email}</span>
                                <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600">
                                    <LogOut size={16} />
                                    Logout
                                </button>
                            </div>
                        </nav>
                    </header>
                    <main className="container mx-auto">
                        {isAdmin ? 
                            <AdminPanel clearances={clearances} setNotification={setNotification} /> : 
                            <UserPanel clearances={clearances} />
                        }
                    </main>
                </>
            )}
        </div>
    );
}

