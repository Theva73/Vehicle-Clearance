<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vehicle Clearance System</title>

<style>
/* ─────────────── Base reset ─────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Arial,sans-serif}
html,body{height:100%;background:#111;color:#f5f5f5}
body{display:flex;flex-direction:column}
button{cursor:pointer;border:none;background:#2563eb;color:#fff;padding:.6rem 1rem;border-radius:.4rem;font-weight:600;transition:opacity .15s}
button:disabled{opacity:.4;cursor:not-allowed}
a{color:#93c5fd}
input,select,textarea{background:#1f1f1f;color:#f5f5f5;border:1px solid #333;border-radius:.3rem;padding:.55rem .65rem;width:100%}
input:focus,select:focus,textarea:focus{outline:none;border-color:#2563eb}
label{font-size:.85rem;margin-bottom:.25rem;display:block;color:#cbd5e1}
h1,h2,h3{font-weight:700;line-height:1.2;margin-bottom:.6rem;color:#f5f5f5}
h1{font-size:1.6rem}
h2{font-size:1.25rem;margin-top:1.2rem}
h3{font-size:1rem;margin-top:.8rem}
.container{width:100%;max-width:1100px;margin:auto;padding:1.2rem}
.hidden{display:none!important}
.flex{display:flex}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.mt-2{margin-top:.5rem}
.mt-4{margin-top:1rem}
.mt-6{margin-top:1.5rem}
.mb-4{margin-bottom:1rem}
.gap-2{gap:.5rem}
.gap-4{gap:1rem}
.grid{display:grid}
.grid-2{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
.table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:.9rem}
.table th,.table td{border:1px solid #333;padding:.55rem .6rem;text-align:left}
.table th{background:#1e293b;color:#e2e8f0;font-weight:600}
.badge{display:inline-block;padding:.15rem .45rem;border-radius:.25rem;font-size:.7rem;font-weight:600}
.badge.green{background:#16a34a33;color:#4ade80;border:1px solid #16a34a66}
.badge.red{background:#dc262633;color:#f87171;border:1px solid #dc262666}
.toast{position:fixed;bottom:1.2rem;right:1.2rem;background:#1e293b;color:#fff;padding:.9rem 1.1rem;border-radius:.4rem;box-shadow:0 0 12px #0008;opacity:0;transform:translateY(20px);transition:.25s}
.toast.show{opacity:1;transform:translateY(0)}
/* modal */
.modal-backdrop{position:fixed;inset:0;background:#000a;display:flex;align-items:center;justify-content:center;z-index:50}
.modal{background:#1f2937;padding:1.2rem 1.4rem;border-radius:.5rem;max-width:500px;width:90%;box-shadow:0 0 22px #000b}
.modal header{font-size:1.1rem;font-weight:600;margin-bottom:.8rem}
.modal footer{margin-top:1rem;display:flex;justify-content:flex-end;gap:.6rem}
textarea{min-height:80px;resize:vertical}
.tag{background:#374151;padding:.2rem .5rem;border-radius:.3rem;font-size:.75rem;margin-right:.3rem;margin-bottom:.3rem;display:inline-block}
hr{border:none;border-top:1px solid #333;margin:1rem 0}
</style>
</head>

<body>
  <div class="container">
    <header class="flex-between mb-4">
      <h1>Vehicle Clearance System</h1>
      <nav class="flex gap-2">
        <button data-nav="home">Home</button>
        <button data-nav="new">New Clearance</button>
        <button data-nav="list">Records</button>
        <button data-nav="about">About</button>
      </nav>
    </header>

    <!-- ─────────────── VIEWS ─────────────── -->
    <section id="view-home">
      <h2>Front Page</h2>
      <p class="mt-2">Welcome! Use the buttons above to navigate. If buttons didn’t work before, this build fixes the event handlers and load errors.</p>
      <div class="mt-4 flex gap-4">
        <button data-nav="new">Create New</button>
        <button data-nav="list">View Records</button>
      </div>
    </section>

    <section id="view-new" class="hidden">
      <h2>Create Vehicle Clearance</h2>
      <form id="clearance-form" class="mt-4 grid gap-4">
        <div>
          <label for="driverName">Driver Name</label>
          <input id="driverName" required />
        </div>
        <div>
          <label for="vehicleNo">Vehicle No / Plate</label>
          <input id="vehicleNo" required />
        </div>
        <div>
          <label for="purpose">Purpose</label>
          <textarea id="purpose" required></textarea>
        </div>
        <div class="grid-2">
          <div>
            <label for="departDate">Depart Date/Time</label>
            <input id="departDate" type="datetime-local" required />
          </div>
          <div>
            <label for="returnDate">Expected Return</label>
            <input id="returnDate" type="datetime-local" required />
          </div>
        </div>
        <div>
          <label for="remarks">Remarks (optional)</label>
          <textarea id="remarks"></textarea>
        </div>
        <div class="flex gap-2 mt-2">
          <button type="submit">Save</button>
          <button type="button" id="btn-reset" style="background:#475569">Reset</button>
          <button type="button" data-nav="home" style="background:#6b7280">Cancel</button>
        </div>
      </form>
    </section>

    <section id="view-list" class="hidden">
      <h2>All Records</h2>
      <div class="mt-2 flex-between">
        <div class="flex gap-2">
          <input id="searchBox" placeholder="Search driver / vehicle / purpose..." style="max-width:260px" />
          <select id="statusFilter" style="max-width:170px">
            <option value="">All Status</option>
            <option value="OPEN">OPEN</option>
            <option value="CLOSED">CLOSED</option>
          </select>
        </div>
        <button id="btn-export">Export JSON</button>
      </div>

      <table class="table" id="recordsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Driver</th>
            <th>Vehicle</th>
            <th>Purpose</th>
            <th>Depart</th>
            <th>Return</th>
            <th>Status</th>
            <th style="width:120px">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="view-about" class="hidden">
      <h2>About</h2>
      <p class="mt-2">Single-file demo. Data is stored in <b>localStorage</b>. Replace storage layer with your backend if needed.</p>
      <hr />
      <h3>Quick Tips</h3>
      <ul style="margin-left:1.2rem;list-style:disc">
        <li>If the page “fails to load”, check console for syntax errors. This build avoids undefined refs and binds listeners after DOM is ready.</li>
        <li>Buttons include a <code>data-nav</code> attribute; a single router function swaps views.</li>
        <li>Everything is namespaced under <code>VCS</code> in localStorage.</li>
      </ul>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Modal (edit) -->
  <template id="modal-template">
    <div class="modal-backdrop">
      <div class="modal">
        <header></header>
        <section></section>
        <footer></footer>
      </div>
    </div>
  </template>

<script>
/* ──────────────────────────────────────────────────────────────
   Vehicle Clearance SPA (no external JS deps)
   - Simple hash-less router
   - LocalStorage persistence
   - Modal editor
────────────────────────────────────────────────────────────── */

const STORAGE_KEY = 'VCS_RECORDS';

/* ------------- UTILITIES ------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

function toast(msg, ms=2600){
  const el = $('#toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), ms);
}

function uuid(){
  return 'xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g,c=>{
    const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}

function saveRecords(records){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
}
function loadRecords(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  }catch(e){
    return [];
  }
}

function formatDT(dt){
  if(!dt) return '';
  const d = new Date(dt);
  if(isNaN(d)) return dt;
  return d.toLocaleString();
}

/* ------------- ROUTER ------------- */
const views = {
  home: $('#view-home'),
  new: $('#view-new'),
  list: $('#view-list'),
  about: $('#view-about')
};

function showView(name){
  Object.values(views).forEach(v=>v.classList.add('hidden'));
  (views[name] || views.home).classList.remove('hidden');
}

function bindNav(){
  $$('button[data-nav]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const v = e.currentTarget.dataset.nav;
      showView(v);
      if(v==='list'){ renderTable(); }
    });
  });
}

/* ------------- FORM HANDLING ------------- */
const form = $('#clearance-form');
$('#btn-reset').onclick = ()=> form.reset();

form.addEventListener('submit', e=>{
  e.preventDefault();
  const rec = {
    id: uuid(),
    driverName: $('#driverName').value.trim(),
    vehicleNo: $('#vehicleNo').value.trim(),
    purpose: $('#purpose').value.trim(),
    departDate: $('#departDate').value,
    returnDate: $('#returnDate').value,
    remarks: $('#remarks').value.trim(),
    status: 'OPEN',
    createdAt: new Date().toISOString()
  };
  const records = loadRecords();
  records.push(rec);
  saveRecords(records);
  form.reset();
  toast('Record saved');
  showView('list');
  renderTable();
});

/* ------------- TABLE RENDER ------------- */
const tbody = $('#recordsTable tbody');
const searchBox = $('#searchBox');
const statusFilter = $('#statusFilter');

searchBox.addEventListener('input', renderTable);
statusFilter.addEventListener('change', renderTable);

function renderTable(){
  const q = searchBox.value.toLowerCase();
  const status = statusFilter.value;
  const records = loadRecords();

  const filtered = records.filter(r=>{
    const hay = `${r.driverName} ${r.vehicleNo} ${r.purpose}`.toLowerCase();
    const sOK = status ? r.status === status : true;
    return hay.includes(q) && sOK;
  });

  tbody.innerHTML = '';
  filtered.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.driverName}</td>
      <td>${r.vehicleNo}</td>
      <td>${r.purpose}</td>
      <td>${formatDT(r.departDate)}</td>
      <td>${formatDT(r.returnDate)}</td>
      <td><span class="badge ${r.status==='OPEN'?'green':'red'}">${r.status}</span></td>
      <td>
        <button data-act="edit" data-id="${r.id}" style="background:#4b5563;font-size:.8rem;padding:.35rem .6rem">Edit</button>
        <button data-act="del" data-id="${r.id}" style="background:#dc2626;font-size:.8rem;padding:.35rem .6rem">Del</button>
      </td>`;
    tbody.appendChild(tr);
  });

  // action buttons
  $$('button[data-act="edit"]').forEach(b=>b.onclick = () => openEdit(b.dataset.id));
  $$('button[data-act="del"]').forEach(b=>b.onclick = () => delRecord(b.dataset.id));
}

function delRecord(id){
  if(!confirm('Delete this record?')) return;
  let records = loadRecords().filter(r=>r.id!==id);
  saveRecords(records);
  toast('Deleted');
  renderTable();
}

/* ------------- EDIT MODAL ------------- */
function openEdit(id){
  const records = loadRecords();
  const rec = records.find(r=>r.id===id);
  if(!rec){ toast('Record missing'); return; }

  const tmpl = $('#modal-template').content.cloneNode(true);
  const modal = tmpl.querySelector('.modal-backdrop');
  const header = tmpl.querySelector('header');
  const body   = tmpl.querySelector('section');
  const footer = tmpl.querySelector('footer');

  header.textContent = 'Edit Record';

  body.innerHTML = `
    <label>Driver Name<input id="e_driverName" value="${rec.driverName}"></label>
    <label class="mt-2">Vehicle No<input id="e_vehicleNo" value="${rec.vehicleNo}"></label>
    <label class="mt-2">Purpose<textarea id="e_purpose">${rec.purpose}</textarea></label>
    <label class="mt-2">Depart<input id="e_departDate" type="datetime-local" value="${rec.departDate}"></label>
    <label class="mt-2">Return<input id="e_returnDate" type="datetime-local" value="${rec.returnDate}"></label>
    <label class="mt-2">Remarks<textarea id="e_remarks">${rec.remarks||''}</textarea></label>
    <label class="mt-2">Status
      <select id="e_status">
        <option value="OPEN" ${rec.status==='OPEN'?'selected':''}>OPEN</option>
        <option value="CLOSED" ${rec.status==='CLOSED'?'selected':''}>CLOSED</option>
      </select>
    </label>
  `;

  const btnSave = document.createElement('button');
  btnSave.textContent = 'Save';
  const btnClose = document.createElement('button');
  btnClose.textContent = 'Cancel';
  btnClose.style.background = '#6b7280';

  footer.append(btnClose, btnSave);
  document.body.appendChild(modal);

  btnClose.onclick = ()=> modal.remove();
  modal.addEventListener('click',e=>{ if(e.target===modal) modal.remove(); });

  btnSave.onclick = ()=>{
    rec.driverName = $('#e_driverName').value.trim();
    rec.vehicleNo  = $('#e_vehicleNo').value.trim();
    rec.purpose    = $('#e_purpose').value.trim();
    rec.departDate = $('#e_departDate').value;
    rec.returnDate = $('#e_returnDate').value;
    rec.remarks    = $('#e_remarks').value.trim();
    rec.status     = $('#e_status').value;

    saveRecords(records);
    modal.remove();
    toast('Updated');
    renderTable();
  };
}

/* ------------- EXPORT ------------- */
$('#btn-export').onclick = ()=>{
  const data = JSON.stringify(loadRecords(), null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'vehicle_clearance_export.json';
  a.click();
  URL.revokeObjectURL(url);
};

/* ------------- INIT ------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  bindNav();
  renderTable();
});
</script>
</body>
</html>