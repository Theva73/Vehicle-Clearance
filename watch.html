<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Watch Vehicle Search</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --text: #ffffff;
            --muted: #8e8e93;
            --panel: #1c1c1e;
            --outline: #3a3a3c;
            --action-orange: #ff9500;
            --action-orange-dark: #cc7a00;
            --status-green: #34c759;
            --status-red: #ff3b30;
        }

        /* Simplified layout for watch compatibility */
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 16px;
            box-sizing: border-box;
            -webkit-user-select: none; /* Prevent text selection issues */
        }

        .container {
            width: 100%;
        }

        /* --- Status Display --- */
        .status-bar {
            text-align: center;
            padding: 8px;
            margin-bottom: 20px;
            border-radius: 12px;
            background-color: var(--panel);
            font-weight: 700;
            font-size: 16px;
            color: var(--muted);
            border: 1px solid var(--outline);
            transition: all 0.3s ease;
        }
        .status-bar.listening {
            background-color: var(--action-orange);
            color: var(--bg);
            font-weight: 900;
        }
        .status-bar.synced {
            background-color: #19382f;
            color: var(--status-green);
        }
        .status-bar.disabled {
             background-color: #3d1c1c;
             color: var(--status-red);
        }

        /* --- Action Button (Voice) --- */
        .voice-btn {
            width: 100%;
            padding: 20px;
            border-radius: 20px;
            border: none;
            background: linear-gradient(145deg, var(--action-orange), var(--action-orange-dark));
            color: var(--text);
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            margin-bottom: 20px;
        }
        .voice-btn.disabled {
            background: var(--panel);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .voice-btn.listening {
            animation: pulse-orange 1.5s infinite;
        }

        /* --- Search Panel --- */
        .search-panel {
            width: 100%;
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        .search-input {
            flex-grow: 1;
            border: 1px solid var(--outline);
            background-color: var(--panel);
            border-radius: 12px;
            padding: 14px;
            font-size: 20px;
            color: var(--text);
            text-align: center;
            font-family: monospace;
            -webkit-user-select: text; /* Allow text selection in this field */
        }
        .clear-btn {
            flex-shrink: 0;
            width: 50px;
            border: none;
            border-radius: 12px;
            background-color: var(--panel);
            color: var(--muted);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- Result Display --- */
        #result-container {
            width: 100%;
            margin-top: 10px;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        #result-container.visible {
            opacity: 1;
            transform: scale(1);
        }
        .result-card {
            padding: 20px;
            border-radius: 20px;
            text-align: center;
        }
        .result-card.cleared {
            background: linear-gradient(145deg, #2e5c41, #1a3b2a);
            border: 2px solid var(--status-green);
        }
        .result-card.not-found {
            background: linear-gradient(145deg, #6b2121, #450a0a);
            border: 2px solid var(--status-red);
        }
        .result-status {
            font-size: 24px;
            font-weight: 900;
            margin: 0 0 8px 0;
            text-transform: uppercase;
        }
        .result-status.cleared { color: var(--status-green); }
        .result-status.not-found { color: var(--status-red); }
        
        .result-plate {
            font-family: monospace;
            font-size: 32px;
            font-weight: bold;
            color: var(--text);
            margin: 0 0 12px 0;
        }
        .result-location {
            font-size: 18px;
            font-weight: 700;
            color: var(--muted);
            margin: 0;
        }

        @keyframes pulse-orange {
            0% { box-shadow: 0 0 0 0 rgba(255, 149, 0, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(255, 149, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 149, 0, 0); }
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="statusBar" class="status-bar">Connecting...</div>

        <button id="micBtn" class="voice-btn" role="button">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 14C13.6569 14 15 12.6569 15 11V5C15 3.34315 13.6569 2 12 2C10.3431 2 9 3.34315 9 5V11C9 12.6569 10.3431 14 12 14ZM11 5C11 4.44772 11.4477 4 12 4C12.5523 4 13 4.44772 13 5V11C13 11.5523 12.5523 12 12 12C11.4477 12 11 11.5523 11 11V5Z"/>
                <path d="M18 11C18 14.3137 15.3137 17 12 17C8.68629 17 6 14.3137 6 11H4C4 14.866 6.96447 18.2353 10.75 18.8536V22H13.25V18.8536C17.0355 18.2353 20 14.866 20 11H18Z"/>
            </svg>
            <span>Voice Search</span>
        </button>

        <div class="search-panel">
            <input id="searchBox" class="search-input" type="text" placeholder="----" inputmode="numeric">
            <button id="clearSearchBtn" class="clear-btn" role="button">X</button>
        </div>

        <div id="result-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC51Zo7V75JjOpLOdusf6ZKUzEG_gqFcV4",
            authDomain: "vehicle-clearance.firebaseapp.com",
            projectId: "vehicle-clearance",
            storageBucket: "vehicle-clearance.appspot.com",
            messagingSenderId: "187403368572",
            appId: "1:187403368572:web:1f94845da67ef0c7ccf1f9"
        };

        let db;
        let allRows = [];
        const searchBox = document.getElementById('searchBox');
        const micBtn = document.getElementById('micBtn');
        const statusBar = document.getElementById('statusBar');
        const resultContainer = document.getElementById('result-container');

        // --- Core App Logic ---
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    const listingsCollection = collection(db, 'vehicleListings');
                    onSnapshot(listingsCollection, (snapshot) => {
                        allRows = snapshot.docs.map(doc => doc.data());
                        statusBar.textContent = `Ready (${allRows.length} vehicles)`;
                        statusBar.classList.add('synced');
                    }, (error) => {
                        statusBar.textContent = "Sync Error";
                        console.error("Firestore snapshot error:", error);
                    });
                } else {
                    signInAnonymously(auth).catch(error => {
                        statusBar.textContent = "Auth Error";
                        console.error("Anonymous sign-in failed:", error);
                    });
                }
            });
        } catch (err) {
            statusBar.textContent = "Connection Failed";
            console.error("Firebase init error:", err);
        }

        // --- Search and Render Logic ---
        function applyFilter() {
            const term = searchBox.value.trim().toUpperCase();
            resultContainer.classList.remove('visible');

            if (!term) return;
            if (term.length < 1) return;

            const result = allRows.find(r => r.vehicleNumber && r.vehicleNumber.replace(/[^0-9]/g, '').startsWith(term));
            
            setTimeout(() => renderResult(result, term), 50);
        }
        
        function renderResult(result, term) {
            if (result) {
                resultContainer.innerHTML = `
                    <div class="result-card cleared">
                        <p class="result-status cleared">✓ Cleared</p>
                        <p class="result-plate">${result.vehicleNumber}</p>
                        <p class="result-location">Location: ${result.location || 'N/A'}</p>
                    </div>
                `;
            } else {
                resultContainer.innerHTML = `
                    <div class="result-card not-found">
                        <p class="result-status not-found">✗ Not Found</p>
                        <p class="result-plate">${term}</p>
                        <p class="result-location">Vehicle not on list</p>
                    </div>
                `;
            }
            resultContainer.classList.add('visible');
        }

        searchBox.addEventListener('input', applyFilter);
        document.getElementById('clearSearchBtn').addEventListener('click', () => {
            searchBox.value = '';
            resultContainer.classList.remove('visible');
        });

        // --- Voice Recognition ---
        let recognition = null;

        function initializeVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return false;
            
            try {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    micBtn.classList.add('listening');
                    statusBar.classList.add('listening');
                    statusBar.textContent = "Listening...";
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const detectedNumber = transcript.replace(/\D/g, '');
                    if (detectedNumber) {
                        searchBox.value = detectedNumber;
                        applyFilter();
                    }
                };

                recognition.onerror = (event) => {
                    statusBar.textContent = "Voice Error";
                    console.error('Voice recognition error:', event.error);
                };

                recognition.onend = () => {
                    micBtn.classList.remove('listening');
                    statusBar.classList.remove('listening');
                    statusBar.textContent = `Ready (${allRows.length} vehicles)`;
                };
                return true;
            } catch (e) {
                console.error("Speech Recognition could not be initialized:", e);
                return false;
            }
        }

        micBtn.addEventListener('click', () => {
            if (recognition && !micBtn.disabled) {
                try {
                    recognition.start();
                } catch(e) {
                    console.error("Could not start recognition:", e);
                    statusBar.textContent = "Voice Start Failed";
                }
            }
        });

        // --- Device Specific Setup ---
        window.addEventListener('load', () => {
            const hasSpeechRecognition = initializeVoiceRecognition();

            if (!hasSpeechRecognition) {
                micBtn.classList.add('disabled');
                micBtn.disabled = true;
                statusBar.textContent = "Manual Search Only";
                statusBar.classList.add('disabled');
            }
        });

    </script>
</body>
</html>
